//
//Scripts for Case data
//
//User clicks on Case Data in left-side navigation
//Listen for edit
//Submit the form
//Cancel New Case or Edit
//Listen for print
//Add another multi-text or dual
//Creates the Case Detail window when user clicks on table row.
//
//Function which creates the tabs in the case_detail_tab_row div
//Function which creates the case detail window.
//Toggle the div #case_detail_window div
// Check for unsaved changes
//Check for conflicts
//Listeners
//User click the minimize, maximinze button on tab row
//User clicks the close button on tab row
//Open the user detail window when user image is clicked.
//Toggle to show all users, not just currently assigned
//Call Add User Widget
//Add Users to Case
//Unassign or re-assign user from case
//Close tabs
//Adjust case detail div sizes on window resize
//
//Scripts for casenotes
//
//Set max height for case notes and add toggle
//functions to mimic php nl2br and br2nlP
//Load new case notes on scroll
//
//Listeners
//
//show hidden text on clipped case note
//Load new case note widget
//Start timer
//Print displayed case notes
//User cancels adding new case note
//User click to add new case note
//User deletes a case note.  By rule, user can only delete casenote he created
//edit case note
//Listen for click
//Scripts for conflicts
// Scripts for contacts panel on cases tab
//
//html widgets
//User clicks on Contacts in left-side navigation
//Listeners
//show hidden text on clipped contact
//Add contact
//Print displayed contacts
//Updates the displayed contact name when user creates a new contact
//Sets default text on contact title
//handle search
//edit contact
//Delete Contact
//Listeners to add new fields
//Scripts for documents panel on cases tab
//
//User clicks to open document window
//User clicks a folder or document
//User clicks new document button
//User clicks new folder button
//User clicks on the upload button
//User clicks the Home link in the directory path
//User clicks one of the other links in the directory path
//Owner can lock the document for editing by others
//
// Scripts for events panel on cases
//
//User clicks on Events in left-side navigation
//Add event
//Updates the displayed event name when user creates a new event
//handle search
//Delete Event
//Print displayed events
//edit event
//Scripts for messages panel on cases tab
//
//Load new messages on scroll
//Checks if a div is overflowing.  See http://stackoverflow.com/a/143889/49359
//User clicks to open messages window
//Listeners
//Toggle message message open/closed state, retrieve replies
//Listen for when user stars message
//Show reply textarea
//Handle print
//TODO enable print
//Expand 'to' field when it overflows
//handle search
//Send message
//Filtering for date fields
function formatCaseData(e,t){var a=e.siblings(".case_detail_nav").find("#item2"),s=a.outerHeight(),i=a.closest(".case_detail_nav").height();if(n===void 0)var n=i-s;if($("div.case_detail_panel_tools").css({height:s}),$("div.case_detail_panel_casenotes").css({height:n}),$("div.case_detail_panel_tools_left").css({width:"30%"}),$("div.case_detail_panel_tools_right").css({width:"70%"}),e.find("div.case_data_value").not("div.case_data_name + div.case_data_value").css({"margin-left":"21%"}),$(".case_detail_panel_casenotes").bind("scroll",function(){var e=$(this).scrollTop();0===e&&$(this).hasClass("csenote_shadow")?$(this).removeClass("csenote_shadow"):$(this).addClass("csenote_shadow")}),"new"===t||"edit"===t){e.find('input[name="id"]').parent().hide(),e.find('input[name="opened_by"]').parent().remove(),"New Case"===e.find('input[name="organization"]').val()&&e.find('input[name="organization"]').val("");var o=e.find('input[name="clinic_id"]'),l=o.val();-1!==l.indexOf("ClinicType")&&e.find('select[name="clinic_type"]').change(function(){o.val(l.replace("ClinicType",$(this).find("option:selected").attr("data-code")))}),-1!==l.indexOf("CaseType")&&e.find('select[name="case_type"]').change(function(){o.val(l.replace("CaseType",$(this).find("option:selected").attr("data-code")))}),$(window).bind("beforeunload",function(){return"You may have unsaved changes on a case.  Please either save any changes or close the case's tab before leaving this page"}),e.find('input[name="clinic_id"]').attr("disabled",!0).after('<a class="force_edit small" href="#">Let me edit this</a>'),e.find("a.force_edit").click(function(t){t.preventDefault();var a=$('<div class="dialog-casenote-delete" title="Are you sure?"><p>ClinicCases automatically assigns the next available case number.  If your case number contains "CaseType" or "ClinicType", these values will be replaced when you change those fields below.</p><br /><p>Manually editing a case number may have undesirable results. Are you sure?</p></div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$('input[name="clinic_id"]').attr("disabled",!1).focus(),e.find("a.force_edit").remove(),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(a).dialog("open")}),""!==e.find('input[name="date_close"]').val()&&(e.find('input[name="date_close"]').after('<a class="force_reopen small" href="#">Re-open this case</a>'),e.find("a.force_reopen").click(function(t){t.preventDefault();var a=$('<div class="dialog-casenote-delete" title="Are you sure?"><p>This will re-open the case. Are you sure?</p></div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$('input[name="date_close"]').datepicker("setDate",null).next().html(""),$('select[name="dispo"]').val("").trigger("liszt:updated"),e.find("a.force_reopen").remove(),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(a).dialog("open")})),e.find("select").chosen(),e.find("span.dual_input").not("label + span.dual_input").css({"margin-left":"190px"}),e.find("span.multi-text").not("label + span.multi-text").css({"margin-left":"190px"}),e.find("p").has("span.dual_input").each(function(){$(this).find("span.dual_input").last().after('<a class="add_another small" href="#">Add another</a>')}),e.find("p").has("span.multi-text").each(function(){$(this).find("span.multi-text").last().after('<a class="add_another small" href="#">Add another</a>')}),e.find("input.date_field").each(function(){var e=$.datepicker.parseDate("yy-mm-dd",$(this).val()),t=$.datepicker.formatDate("mm/dd/yy",e);$(this).datepicker({dateFormat:"yy-mm-dd",showOn:"button",buttonText:t,onSelect:function(e){var t=$.datepicker.parseDate("yy-mm-dd",e),a=$.datepicker.formatDate("mm/dd/yy",t);$(this).next().html(a)}})}),e.find("textarea").TextAreaExpander(100,250),$("#case_detail_tab_row").find("li.ui-state-active").addClass("ui-state-highlight"),e.find('input[name="first_name"]').focus(),$('input[name = "last_name"]').keyup(function(){var t=e.find('input[name="first_name"]').val();$(this).closest("#case_detail_tab_row").find("li.ui-state-active").find("a").html($(this).val()+", "+t),$(this).closest("#case_detail_tab_row").find("div.case_title").html("<h2>"+t+" "+$(this).val()+"</h2>")}),$('input[name = "organization"]').keyup(function(){var e=$(this).closest("form").find('input[name="last_name"]').val();""===e&&($(this).closest("#case_detail_tab_row").find("li.ui-state-active").find("a").html($(this).val()),$(this).closest("#case_detail_tab_row").find("div.case_title").html("<h2>"+$(this).val()+"</h2>"))})}else e.find("button.case_data_edit").button({icons:{primary:"fff-icon-page-edit"},text:!0}),e.find("button.case_data_print").button({icons:{primary:"fff-icon-printer"},text:!0}),e.find("div.id_display").remove()}function setDetailCss(){var e,t=Math.ceil($("#case_detail_window").width()),a=Math.ceil($("#case_detail_window").height()),s=.004*$("#case_detail_window").width(),i=Math.floor(.15*t),n=t-i-s-10,o=Math.floor($(.07*a));e=o>52?o:52;var l=a-$("#case_detail_tab_row").height()-e,c=t-3,d=l,r=e-10;$(".case_detail_nav").css({height:l,width:i}),$(".case_detail_panel").css({height:d,width:n}),$(".case_detail_bar").css({height:e,width:c}),$(".case_title").css({height:r})}function addDetailTabs(e,t){$(function(){var a,s,i=$("ul.ui-tabs-nav > li").length;return 5===i?($("#error").text("Sorry, but ClinicCases can only open a maximum of five cases at a time.").dialog({modal:!0,title:"Error"}),!1):($.getJSON("lib/php/data/cases_detail_tab_case_name.php?id="+e,function(i){a=1>i.organization.length?i.last_name+", "+i.first_name:i.organization,a.length>12&&(a=a.substring(0,12)+"..."),$tabs=$("#case_detail_tab_row").tabs({tabTemplate:'<li><a href="#{href}">#{label}</a> <span class="ui-icon ui-icon-close">Remove Tab</span></li>'}),$tabs.tabs("add","lib/php/data/cases_detail_load.php?id="+e,a),$tabs.tabs({add:function(e,t){$tabs.tabs("select","#"+t.panel.id)},cache:!0,load:function(i,n){setDetailCss(),$("#case_detail_bar").text(a),t===!0&&$(n.tab).parent().addClass("new_case"),$("div.assigned_people  button").length>0&&$("div.assigned_people  button").button({icons:{primary:"fff-icon-user-add"},text:!0}),s=$(".assigned_people").jScrollPane(),panelTarget=n.panel,$(panelTarget).find(" .case_detail_panel").data("CaseNumber",e),t===!0?$(panelTarget).find(".case_detail_nav li#item2").addClass("new_case").trigger("click"):(loadCaseNotes(panelTarget,e),checkConflicts(e))}}),$("ul.ui-tabs-nav").removeClass("ui-corner-all").addClass("ui-corner-top"),$("#case_detail_tab_row").removeClass("ui-corner-all").addClass("ui-corner-top")}),void 0)})}function callCaseWindow(e,t){if(1>$("#case_detail_window").length){var a='<div id="case_detail_window"><div id="case_detail_tab_row"><ul></ul><div id="case_detail_control"></div></div></div>';$("#content").append(a),$("#case_detail_window").hide().show("fold",600,function(){setDetailCss(),addDetailTabs(e,t)}),$("#case_detail_control").html("<button></button><button></button>"),$("#case_detail_control button:first").button({icons:{primary:"fff-icon-arrow-in"},label:"Minimize"}).next().button({icons:{primary:"fff-icon-cancel"},label:"Close"})}else"Maximize"===$("#case_detail_control button:first").text()?(toggleTabs(),addDetailTabs(e,t)):$("#case_detail_window").hide().show("fold",600,function(){setDetailCss(),addDetailTabs(e,t)})}function toggleTabs(){var e=adjustedHeight+8;if("Minimize"===$("#case_detail_control button:first").text())$("#case_detail_window").animate({top:e}),$("#case_detail_control button:first").button({icons:{primary:"fff-icon-arrow-out"},label:"Maximize"}),$("#case_detail_control button:first .ui-button-text").css({"line-height":"0.3"});else{var t=.021*adjustedHeight;$("#case_detail_window").animate({top:t}),$("#case_detail_control button:first").button({icons:{primary:"fff-icon-arrow-in"},label:"Minimize"}),$("#case_detail_control button:first .ui-button-text").css({"line-height":"0.3"})}}function closeCaseTab(e,t){if(e===!0){var a=$("li",$tabs).index(t),s=$("ul.ui-tabs-nav > li").length;1===s?$("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")}):$tabs.tabs("remove",a)}}function tabCheckDirty(e){var t=$('<div title="Warning: Unsaved Changes">You are currently editing a case. Lose any changes?</div>'),a=e.find("a").attr("href"),s=$(a).find(".case_detail_panel").data("CaseNumber");e.first().hasClass("ui-state-highlight")?(e.addClass("ui-state-error"),t.dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){if(e.size()>1&&e.hasClass("new_case")){var t=[];e.each(function(){a=$(this).find("a").attr("href"),s=$(a).find(".case_detail_panel").data("CaseNumber"),$.post("lib/php/data/cases_case_data_process.php",{action:"delete",id:s},function(e){var a=$.parseJSON(e);a.error===!0&&t.push("error")})}),t.length>0?notify("Sorry, there was an error",!0):(notify("Cases deleted."),$("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")}),$(window).unbind("beforeunload"))}else e.hasClass("new_case")?$.post("lib/php/data/cases_case_data_process.php",{action:"delete",id:s},function(t){var a=$.parseJSON(t);a.error===!0?notify(a.message,!0):(notify(a.message),closeCaseTab(!0,e),$(window).unbind("beforeunload"))}):e.size()>1?($("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")}),$(window).unbind("beforeunload")):(closeCaseTab(!0,e),$(window).unbind("beforeunload"));$(this).dialog("destroy")},No:function(){closeCaseTab(!1),$(this).dialog("destroy")}}}),$(t).dialog("open")):closeCaseTab(!0,e)}function checkConflicts(e){$.post("lib/php/data/cases_conflicts_load.php",{case_id:e,type:"alert"},function(e){var t=$.parseJSON(e);t.conflicts===!0&&$(panelTarget).find("span.conflicts_number").html('<span class="msg_number"> ('+t.number+")</span>")})}function sizeCaseNotes(e,t){var a=t.height(),s=.3*t.height();e.each(function(){$(this).data("maxCaseNoteHeight",$(this).height()),$(this).data("minCaseNoteHeight",s);var e=100*($(this).height()/a);e>40&&($(this).height(s),$(this).css({overflow:"hidden"}),$(this).append('<div class="more"><a href="#">More</a></div>'))})}function addMoreNotes(e){var t,a=e.data("CaseNumber"),s=e[0].scrollTop,i=e[0].scrollHeight;0===s&&e.hasClass("csenote_shadow")?e.removeClass("csenote_shadow"):e.addClass("csenote_shadow");var n=100*(s/(i-e.height()));n>70&&(e.data("start")===void 0?(t=20,e.data("start",t)):(t=e.data("start")+20,e.data("start",t)),$.post("lib/php/data/cases_casenotes_load.php",{case_id:a,start:e.data("start"),update:"yes"},function(t){var a=$(t).find("p.csenote_instance").length;return 0===a?!1:(e.append(t),sizeCaseNotes($(".csenote"),e),$("div.csenote").addClass("ui-corner-all"),"block"===e.find("div.csenote_new").css("display")&&$("div.csenote").css({opacity:".5"}),void 0)}))}function loadCaseNotes(e,t){$(e).find(".case_detail_panel").load("lib/php/data/cases_casenotes_load.php",{case_id:t,start:"0"},function(){var a=$(e).find(".case_detail_nav li:first").outerHeight(),s=$(e).find(".case_detail_nav").height(),i=s-a;$("div.case_detail_panel_tools").css({height:a}),$("div.case_detail_panel_casenotes").css({height:i}),$(".case_detail_panel_tools_right button.button1").length?$(".case_detail_panel_tools_right button.button1").button({icons:{primary:"fff-icon-add"},text:!0}).next().button({icons:{primary:"fff-icon-time"},text:!0}).next().button({icons:{primary:"fff-icon-printer"},text:!0}):$(".case_detail_panel_tools_right button.button3").button({icons:{primary:"fff-icon-printer"},text:!0});var n=$(e).find(".case_detail_panel_casenotes");n.data("CaseNumber",t),$(n).bind("scroll",function(){addMoreNotes(n)}),sizeCaseNotes($(e).find(".csenote"),$(e).find(" .case_detail_panel")),$("div.csenote").addClass("ui-corner-all")})}function sizeContacts(e,t){var a=t.height(),s=.4*t.height();e.not(".new_contact").each(function(){$(this).data("maxContactHeight",$(this).height()),$(this).data("minContactHeight",s);var e=100*($(this).height()/a);e>40&&($(this).height(s),$(this).css({overflow:"hidden"}),$(this).append('<div class="contact_more"><a href="#">More</a></div>'))})}function doEditSelect(e,t){var a,s=["mobile","home","office","fax"],i=["work","home","other"],n="";if("phone"===t){for(a=0;s.length>a;a++)n+=s[a]===e?'<option value = "'+s[a]+'" selected=selected>'+s[a]+"</option>":'<option value = "'+s[a]+'">'+s[a]+"</option>";n+='<a href="#" class="add_phone">Add Another</a>'}else for(a=0;i.length>a;a++)n+=i[a]===e?'<option value = "'+i[a]+'" selected=selected>'+i[a]+"</option>":'<option value = "'+i[a]+'">'+i[a]+"</option>";return n}function createTrail(e){var t=e.split("/"),a="",s="";return $.each(t,function(e,t){s+="/"+t;var i=s.substr(1),n='<a class="doc_trail_item" href="#" path="'+i+'">'+unescape(t)+"</a>/";a+=n}),a}function unescapeNames(){$(".doc_item p, .doc_properties h3").each(function(){var e=unescape($(this).html());$(this).html(e)})}function unescapeNames(){$(".doc_item p, .doc_properties h3").each(function(){var e=unescape($(this).html());$(this).html(e)})}function createDragDrop(){$("div.item, div.folder").draggable("destroy"),$("div.folder").droppable("destroy"),$("div.item").draggable({revert:"invalid",containment:"div.case_detail_panel_casenotes"}),$("div.folder").droppable({activeClass:"ui-state-highlight",drop:function(e,t){var a=null;a=t.draggable.hasClass("folder")?"folder":"item";var s=t.draggable.closest(".case_detail_panel").data("CaseNumber");$.post("lib/php/data/cases_documents_process.php",{action:"cut",item_id:t.draggable.attr("data-id"),target_path:$(e.target).attr("path"),selection_path:t.draggable.attr("path"),doc_type:a,case_id:s},function(e){var a=$.parseJSON(e);notify(a.message),t.draggable.fadeOut()})}}).draggable({revert:"invalid",containment:"div.case_detail_panel_casenotes"})}function createTextEditor(e,t,a,s,i,n,o,l){var c='<div class="text_editor_bar" data-id=""><div class="text_editor_title" tabindex="0">'+s+'</div><div class="text_editor_status"><span class= "status">Unchanged</span></div></div><textarea class="text_editor"></textarea>';e.html(c);var d=e.find(".text_editor_title"),r=e.find(".text_editor_status"),_=e.find(".text_editor_title").html(),p=e.closest(".case_detail_panel").data("CaseNumber"),h=e.closest(".case_detail_panel").data("CurrentPath"),u=e.find(".text_editor_bar"),f=e.siblings(".case_detail_panel_tools");"Home"===h&&(h="");var v=e.find(".text_editor").rte({css:["lib/javascripts/lwrte/default2.css"],width:900,height:400,controls_rte:rte_toolbar});if("view"===t&&(v[0].set_content(i),d.html(unescape(s)),u.attr("data-id",n)),"no"===a&&"1"!==o&&($(v[0].iframe_doc).keydown(function(){return!1}),r.html('<span class="readonly">Read Only</status>'),e.find(".rte-toolbar a").not(".print").css({opacity:".3"}),e.find(".rte-toolbar select").css({opacity:".3"})),"1"===o){var m='<select name="ccd_permission">';m+="no"===l?'<option value="no" selected=selected>Unlocked</option><option value="yes">Locked</option>':'<option value="no" >Unlocked</option><option value="yes" selected=selected>Locked</option>',m+="</select>",r.append(m)}if("new"===t&&$.post("lib/php/data/cases_documents_process.php",{action:"new_ccd",ccd_name:escape(_),local_file_name:"New Document.ccd",path:h,case_id:p},function(e){var t=$.parseJSON(e);u.attr("data-id",t.ccd_id),d.html(unescape(t.ccd_title))}),f.find("button").hide(),f.find(".case_detail_panel_tools_right").append('<button class="closer">Close</button>'),f.find("button.closer").button({icons:{primary:"fff-icon-cross"},text:!0}),f.find("button.closer").click(function(){var t=function(){""===h?e.load("lib/php/data/cases_documents_load.php",{id:p,update:"yes",path:h},function(){f.find("button").show(),f.find("button.closer").remove(),unescapeNames(),createDragDrop()}):e.load("lib/php/data/cases_documents_load.php",{id:p,update:"yes",path:h,container:h},function(){f.find("button").show(),f.find("button.loser").remove(),unescapeNames(),createDragDrop()})};if(""===$(".text_editor").html()&&"New Document"===$(".text_editor_title").text())var a="It appears this document is empty. Do you want to save it anyway?",s=$('<div class=".dialog-casenote-delete" title="Delete this Item?">'+a+"</div>").dialog({autoOpen:!0,resizable:!1,modal:!0,buttons:{Yes:function(){s.dialog("destroy"),t()},No:function(){var e=$(".text_editor_bar").attr("data-id");$.post("lib/php/data/cases_documents_process.php",{action:"delete",item_id:e,doc_type:"ccd"},function(e){var t=$.parseJSON(e);notify(t.message),s.dialog("destroy")}),$(this).dialog("destroy"),t()}}});else t()}),"yes"===a){d.mouseenter(function(){$(this).css({color:"red"})}).click(function(){$(this).html('<input type="text" value="" />'),$(this).find("input").val(unescape(_)).focus().select()}).bind("focusout keyup",function(e){if("focusout"===e.type||13===e.which){if(_=escape($(this).find("input").val()),""===_||"\n"===_)return notify("Please give your document a title.",!0),$(this).find("input").addClass("ui-state-error").focus(),!1;$(this).html(unescape(_)),$(this).css({color:"black"});var t=v[0].get_content();$.post("lib/php/data/cases_documents_process.php",{action:"update_ccd",ccd_name:_,ccd_id:u.attr("data-id"),ccd_text:t},function(e){var t=$.parseJSON(e);notify(t.message)})}}).mouseleave(function(){$(this).css({color:"black"})});var b="",g=function(e,t){var a=t[0].get_content(),s="Saving...";a!==e&&(r.find("span.status").html(s),$.post("lib/php/data/cases_documents_process.php",{action:"update_ccd",ccd_name:d.html(),ccd_id:u.attr("data-id"),ccd_text:a},function(e){var t=$.parseJSON(e);t.error?r.find("span.status").html(t.message):(d.html(t.ccd_title),r.find("span.status").html(t.message))}),e=a),setTimeout(function(){g(e,t)},3e3)};g(b,v)}}function openItem(e,t,a,s,i,n){if($(e).hasClass("folder")){if($(e).hasClass(".ui-draggable-dragging"))return;$(e).closest(".case_detail_panel_casenotes").load("lib/php/data/cases_documents_load.php",{id:s,container:i,path:i,update:"y"},function(){var e=createTrail(i);n.html(e),n.find("a[path='"+i+"']").addClass("active"),createDragDrop(),unescapeNames(),$(this).closest(".case_detail_panel").data("CurrentPath",i),$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var e=$(this).scrollTop();0===e&&$(this).hasClass("csenote_shadow")?$(this).removeClass("csenote_shadow"):$(this).addClass("csenote_shadow")})})}else if($(e).hasClass("url")){if($(e).hasClass(".ui-draggable-dragging"))return;$.post("lib/php/data/cases_documents_process.php",{action:"open",item_id:t,doc_type:"document"},function(e){var t=$.parseJSON(e);window.open(t.target_url,"_blank")})}else if($(e).hasClass("ccd")){if($(e).hasClass(".ui-draggable-dragging"))return;$.post("lib/php/data/cases_documents_process.php",{action:"open",item_id:t,doc_type:"document"},function(t){var a=$.parseJSON(t),s=$(e).closest(".case_detail_panel_casenotes");createTextEditor(s,"view",a.ccd_permissions,a.ccd_title,a.ccd_content,a.ccd_id,a.ccd_owner,a.ccd_locked)})}else if($(e).hasClass("pdf"))Object.create?($("#pdf-viewer").show(),$("#frme").attr("src","lib/javascripts/pdfjs/web/viewer.html?item_id="+t),$("#pdf-viewer").click(function(){$("#frme").attr("src",""),$(this).hide()}),$("body").bind("keyup.pdfViewer",function(e){27===e.keyCode&&($("#frme").attr("src",""),$("#pdf-viewer").hide())})):$.download("lib/php/data/cases_documents_process.php",{item_id:t,action:"open",doc_type:a});else{if($(e).hasClass(".ui-draggable-dragging"))return;$.download("lib/php/data/cases_documents_process.php",{item_id:t,action:"open",doc_type:a})}}function addMoreMessages(e,t,a){var s,i=e[0].scrollTop,n=e[0].scrollHeight,o=100*(i/(n-e.height()));o>70&&(e.data("startVal")===void 0?(s=20,e.data("startVal",s)):(s=e.data("startVal")+parseInt(20),e.data("startVal",s)),"y"===e.data("searchOn")?$.post("lib/php/data/cases_messages_load.php",{type:t,start:e.data("startVal"),s:e.data("searchTerm"),case_id:a,update:"y"},function(t){var a=$(t).find("div").length;return 0===a?!1:(e.append(t),layoutMessages(),e.highlight(e.data("searchTerm")),void 0)}):$.post("lib/php/data/cases_messages_load.php",{type:t,start:e.data("startVal"),case_id:a,update:"y"},function(t){var a=$(t).find("div").length;return 0===a?!1:(e.append(t),layoutMessages(),void 0)}))}function checkOverflow(e){var t=e[0],a=t.style.overflow;a&&"visible"!==a||(t.style.overflow="hidden");var s=t.clientWidth<t.scrollWidth||t.clientHeight<t.scrollHeight;return t.style.overflow=a,s}function layoutMessages(){var e=null;$("p.tos").each(function(){$(this).next("p").hasClass("msg_to_more")||(e=checkOverflow($(this)),e===!0&&($(this).css({overflowY:"hidden"}),$(this).after('<p class="msg_to_more ex_tos"><a href="#">and others</a></p>')))}),$("p.ccs").each(function(){$(this).next("p").hasClass("msg_to_more")||(e=checkOverflow($(this)),e===!0&&($(this).css({overflowY:"hidden"}),$(this).after('<p class="msg_to_more"><a href="#">and others</a></p>')))}),$("div.msg").addClass("ui-corner-all"),$("div.msg_read").css({opacity:".5"})}$(".case_detail_nav #item2").live("click",function(){var e,t=$(this).closest(".case_detail_nav").siblings(".case_detail_panel"),a=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");e=$(this).hasClass("new_case")?"new":"display",t.load("lib/php/data/cases_case_data_load.php",{id:a,type:e},function(){formatCaseData(t,e)})}),$("button.case_data_edit").live("click",function(){var e=$(this).closest(".case_detail_panel"),t=e.data("CaseNumber");e.load("lib/php/data/cases_case_data_load.php",{id:t,type:"edit"},function(){formatCaseData(e,"edit")})}),$("button.case_modify_submit").live("click",function(e){e.preventDefault();var t,a=$(this).closest(".case_detail_panel"),s=a.data("CaseNumber");t=$(this).hasClass("update_new_case")?"update_new_case":"edit",$(window).unbind("beforeunload");var i=$(this).closest("form");i.find('input[name="clinic_id"]').attr({disabled:!1});var n=newCaseValidate(i);if(i.serializeArray(),n.length)return notify(n,!0),$(window).bind("beforeunload",function(){return"You may have unsaved changes on a case.  Please either saveany changes or close the case's tab before leaving this page"}),$("input.ui-state-error").focus(function(){$(this).removeClass("ui-state-error")}),!1;var o=$(this).closest("form").find(":not(span.dual_input input, span.dual_input select, span.multi-text input)").serializeArray();o.push({name:"action",value:t}),i.find("p").has(".multi-text").each(function(){var e={},t=$(this).find("input").attr("name");if($(this).find("span.multi-text").each(function(){var t=$(this).find("input").val();t.length>0&&(e[t]="name")}),!$.isEmptyObject(e)){var a=JSON.stringify(e);o.push({name:t,value:a})}}),i.find("p").has(".dual_input").each(function(){var e={},t=$(this).find("input:last").attr("name");if($(this).find("span.dual_input").each(function(){var t=$(this).find("select.dual").val(),a=$(this).find("input:last").val();a.length>0&&(e[a]=t)}),!$.isEmptyObject(e)){var a=JSON.stringify(e);o.push({name:t,value:a})}}),$.post("lib/php/data/cases_case_data_process.php",o,function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),$("#case_detail_tab_row").find("li.ui-state-active").removeClass("ui-state-highlight ui-state-error new_case"),a.load("lib/php/data/cases_case_data_load.php",{id:s,type:"display"},function(){formatCaseData(a,"display")}),oTable.fnReloadAjax(),checkConflicts(s))})}),$("button.case_cancel_submit").live("click",function(e){e.preventDefault();var t,a=$(this).closest(".case_detail_panel"),s=$(this).closest(".case_detail_panel").data("CaseNumber");if($(this).hasClass("cancel_new_case")){var i=$('<div class="dialog-casenote-delete" title="Are you sure?"><p>This will delete your new case. Are you sure?</p></div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/cases_case_data_process.php",{id:s,action:"delete"},function(e){var t=$.parseJSON(e);if(!t.error){var a=$("li.new_case.ui-state-active");closeCaseTab(!0,a)}notify(t.message)}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(i).dialog("open")}else t="display",a.load("lib/php/data/cases_case_data_load.php",{id:s,type:t},function(){formatCaseData(a,t)});$(window).unbind("beforeunload")}),$("button.case_data_print").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Case Data: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())}),$("a.add_another").live("click",function(e){e.preventDefault();var t=$(this).prev("span").clone();t.find("input").val(""),t.find("select").val(""),t.css({"margin-left":"190px"}),t.find("select").removeClass("chzn-done").css({display:"block"}).removeAttr("id").next("div").remove(),$(this).prev("span").after(t),t.find("select").chosen(),t.find("input").focus()});var $tabs,panelTarget;$("#case_detail_control button:first").live("click",function(){toggleTabs()}),$("#case_detail_control button + button").live("click",function(){var e=$("#case_detail_tab_row").find("li.ui-state-highlight");$.isEmptyObject(e)?$("#case_detail_window").hide("fold",1e3,function(){$tabs.tabs("destroy")}):tabCheckDirty(e)}),$("ul.case_detail_nav_list > li").live("click",function(){$(this).siblings().removeClass("selected"),$(this).addClass("selected")}),$("div.assigned_people img:not(.user_add_button)").live("click",function(){$("div.assigned_people img").css({border:"3px solid #FFFFCC"}),clickedImage=$(this),$(this).parents("li").hasClass("inactive")?$(this).css({border:"3px solid gray"}):$(this).css({border:"3px solid green"});var e=$(this).attr("id").indexOf("_"),t=$(this).attr("id").lastIndexOf("_"),a=$(this).attr("id").substring(e+1,t),s=$(this).attr("id").substring(t+1);$("div.user_display").load("lib/php/users/cases_detail_user_activity_load.php",{case_id:a,username:s},function(){$("div.user_display_detail button").length>0&&($("div.user_display_detail button").parent().hasClass("inactive_user")?$("button.user-action-button").button({icons:{primary:"fff-icon-user-delete"},text:!0,label:"Reassign"}):$("button.user-action-button").button({icons:{primary:"fff-icon-user-delete"},text:!0,label:"Unassign"})),$(this).show();var e=$(this).find("div.user_display_detail");e.focus(),e.blur(function(){setTimeout(function(){e.parent().hide(),clickedImage.css({border:"3px solid #FFFFCC"})},500)})})}),$("div.assigned_people li.slide").live("click",function(){var e=$("div.assigned_people li.inactive"),t=e.css("display");"none"===t?(e.css({display:"inline"}),e.find("img").css({opacity:".4"}),$(this).children().text("Assigned (History):"),$(this).removeClass("closed").addClass("open"),$(".assigned_people").jScrollPane()):(e.css({display:"none"}),$(this).children().text("Assigned:"),$(this).removeClass("open").addClass("closed"),$(".assigned_people").jScrollPane())}),$("div.assigned_people img.user_add_button").live("click",function(){$("div.assigned_people img").css({border:"3px solid #FFFFCC"});var e=$(this);$(this).css({border:"3px solid green"});var t=$(this).attr("id").lastIndexOf("_"),a=$(this).attr("id").substring(t+1);e.css({border:"3px solid #FFFFCC"}),$("div.user_display").load("lib/php/users/cases_detail_user_chooser_load.php",{case_id:a},function(){$("button.user-action-adduser-button").button({icons:{primary:"fff-icon-user-add"},text:!0}),$("div.user_display").show(),$(".chzn-select").chosen(),$("div.user_display form").focus().blur(function(){setTimeout(function(){$("div.user_display").hide()},500)})})}),$("div.user_widget button.user-action-adduser-button").live("click",function(){var e=$(this).parent().find("select").val(),t=$("#user_chooser_case_id").val();$.ajax({url:"lib/php/users/add_user_to_case.php",data:{users_add:e,case_id:t},success:function(e){$(".assigned_people ul").load("lib/php/users/cases_detail_assigned_people_refresh_load.php",{id:t}),$("div.user_widget").hide(),notify(e),oTable.fnReloadAjax()}})}),$("div.user_widget button.user-action-button").live("click",function(){var e=$(this).siblings(".dialog-user-remove"),t=$(this).siblings("form"),a=t.children(".RemoveId").val(),s=t.children(".RemoveImgId").val(),i=s.split("_");$(e).dialog({resizable:!1,modal:!0,buttons:{Yes:function(){$.ajax({url:"lib/php/users/remove_user_from_case.php",data:{remove_id:a},success:function(e){$("div.user_widget").hide(),notify(e),$(".assigned_people ul").load("lib/php/users/cases_detail_assigned_people_refresh_load.php",{id:i[1]}),oTable.fnReloadAjax()}}),$(this).dialog("close")},No:function(){$(this).dialog("close")}}})}),$("span.ui-icon-close").live("click",function(){tabCheckDirty($(this).parent())}),$(window).resize(function(){setDetailCss()}),String.prototype.nl2br=function(){var e;return e=arguments[0]!==void 0?arguments[0]:"<br />",this.replace(/\r\n|\r|\n/g,e)},String.prototype.br2nl=function(){var e;return e=arguments[0]!==void 0?arguments[0]:"\r",this.replace(/\<br(\s*\/|)\>/g,e)},$("div.more").live("click",function(e){e.preventDefault();var t=$(this).closest(".csenote");$(this).closest(".csenote").data("maxCaseNoteHeight");var a=$(this).closest(".csenote").data("minCaseNoteHeight");"Less"===$(this).find("a").html()?(t.css({height:a}),$(this).find("a").html("More")):(t.css({height:"auto"}),$(this).find("a").html("Less"))}),$("input.casenotes_search").live("focusin",function(){$(this).val(""),$(this).css({color:"black"}),$(this).next(".casenotes_search_clear").show()}),$("input.casenotes_search").live("keyup",function(){var e=$(this).closest("div.case_detail_panel_tools").next(),t=$(this).val(),a=e.data("CaseNumber");t.length>2&&(e.unbind("scroll"),e.load("lib/php/data/cases_casenotes_load.php",{case_id:a,search:t,update:"yes"},function(){e.scrollTop(0),t.length&&e.highlight(t),sizeCaseNotes($(".csenote"),e),e.hasClass("csenote_shadow")&&e.removeClass("csenote_shadow"),$("div.csenote").addClass("ui-corner-all"),e.bind("scroll.search",function(){$(this).scrollTop()>0?$(this).addClass("csenote_shadow"):$(this).removeClass("csenote_shadow")})}))}),$(".casenotes_search_clear").live("click",function(){$(this).prev().val("Search Case Notes"),$(this).prev().css({color:"#AAA"});var e=$(this).closest("div.case_detail_panel_tools").next(),t=e.data("CaseNumber");e.load("lib/php/data/cases_casenotes_load.php",{case_id:t,start:"0",update:"yes"},function(){e.scrollTop(0),sizeCaseNotes($(".csenote"),e),$("div.csenote").addClass("ui-corner-all"),e.unbind("scroll.search"),e.bind("scroll",function(){addMoreNotes(e)})}),$(this).hide()}),$(".case_detail_panel_tools_right button.button1").live("click",function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").scrollTop(0);var e=$(this).closest(".case_detail_panel_tools").siblings().find(".csenote_new");e.show(),$(this).closest(".case_detail_panel_tools").siblings().find("textarea").TextAreaExpander(52,200).css({color:"#AAA"}).html("Describe what you did...").mouseenter(function(){$(this).focus().val("").css({color:"black"}).unbind("mouseenter")}),$(this).closest(".case_detail_panel_tools").siblings().find("div.csenote").not("div.csenote_new").css({opacity:".5"});var t=$("input.csenote_date_value").val();$("input.csenote_date_value").datepicker({dateFormat:"m/d/yy",showOn:"button",buttonText:t,onSelect:function(e){$(this).next().html(e)}}),e.find(".csenote_action_submit").button({icons:{primary:"fff-icon-add"}}).next().button({icons:{primary:"fff-icon-cancel"},text:!0})}),$(".case_detail_panel_tools_right button.button2").live("click",function(){var e=$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title h2").html(),t=new Date,a=t.getTime();$("#timer .timer_case_name").html(e),$.cookie("timer_status","on"),$.cookie("timer_start_time",a),$.cookie("timer_case_name",e);var s=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").data("CaseNumber");$.cookie("timer_case_id",s),ccTimer(!0,a),$("#timer").show(),setDetailCss();var i=$("#content").height();$("#content").height(i-45)}),$(".case_detail_panel_tools_right button.button3").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Casenotes: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())
}),$("button.csenote_action_cancel").live("click",function(e){e.preventDefault();var t=$(this).closest(".ui-tabs-panel"),a=$(this).closest(".case_detail_panel").data("CaseNumber");loadCaseNotes(t,a)}),$("button.csenote_action_submit").live("click",function(e){e.preventDefault();var t=$(this).closest("form").serializeArray();$(this).closest;var a=$(this).closest("div.case_detail_panel_casenotes"),s=a.data("CaseNumber"),i=validCaseNote(t);i.length?notify(i,!0):$.post("lib/php/data/cases_casenotes_process.php",t,function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),a.load("lib/php/data/cases_casenotes_load.php",{case_id:s,start:"0",update:"yes"},function(){sizeCaseNotes($(".csenote"),a)}))})}),$("a.csenote_delete").live("click",function(e){e.preventDefault();var t=$(this).closest(".csenote"),a=t.attr("id").split("_"),s=$('<div class=".dialog-casenote-delete" title="Delete this Case Note?">This case note will be permanently deleted.  Are you sure?</div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/cases_casenotes_process.php",{query_type:"delete",csenote_casenote_id:a[1]},function(e){var a=$.parseJSON(e);a.error===!0?notify(a.message,!0):(t.remove(),notify(a.message))}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(s).dialog("open")}),$("a.csenote_edit").live("click",function(e){if(e.preventDefault(),$(this).closest(".case_detail_panel_casenotes").find(".csenote_edit_submit").length)return notify("Only one case note can be edited at a time",!0),!1;var t=$(this).closest(".csenote"),a=t.attr("id").split("_");t.find("span.highlight").length&&t.find("span.highlight").contents().unwrap();var s,i,n=t.find("p.csenote_instance").html().br2nl(),o=$(this).closest("div").children(".csenote_time").html();if(-1===o.indexOf("."))s="0",i=parseInt(o);else{var l=o.split(".");s=l[0],i=parseInt(l[1])}var c=$(this).closest("div").children(".csenote_date").html(),d=$(this).closest("div.csenote").siblings("div.csenote_new").eq(0).clone();t.after(d),d.show(),t.hide(),d.find(".csenote_bar").css({"background-color":"#FEBBBB"}),d.find("textarea").html(n).TextAreaExpander(52,200),d.find('select[name="csenote_hours"]').val(s),d.find('select[name="csenote_minutes"]').val(i),d.find('input[name="query_type"]').val("modify"),d.find("button.csenote_action_submit").html("Done").addClass("csenote_edit_submit").removeClass("csenote_action_submit"),d.find("input.csenote_date_value").val(c).datepicker({dateFormat:"m/d/yy",showOn:"button",buttonText:c,onSelect:function(e){$(this).next().html(e)}}),d.find("form").append('<input type="hidden" name="csenote_casenote_id" value="'+a[1]+'">'),d.find("button.csenote_action_cancel").unbind().bind("click",function(){d.remove(),t.show()}),d.find("button.csenote_action_submit").unbind(),d.find("button.csenote_edit_submit").bind("click",function(e){e.preventDefault();var a=$(this).closest("form").serializeArray(),s=validCaseNote(a);s.length?notify(s,"wait"):$.post("lib/php/data/cases_casenotes_process.php",a,function(e){var s=$.parseJSON(e);if(s.error===!0)notify(s.message,!0);else{t.find(".csenote_date").html(a[0].value);var i=a[6].value.nl2br();t.find("p.csenote_instance").html(i),"0"==a[1].value?t.find(".csenote_time").html(a[2].value+" minutes"):t.find(".csenote_time").html(a[1].value+"."+a[2].value+" hours"),notify(s.message),d.remove(),t.show()}})})}),$(".case_detail_nav #item1").live("click",function(){var e=$(this).closest(".ui-tabs-panel"),t=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber");loadCaseNotes(e,t)}),$(".case_detail_nav #item7").live("click",function(){var e=$(this).closest(".case_detail_nav").siblings(".case_detail_panel"),t=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber"),a=$(this).outerHeight(),s=$(this).closest(".case_detail_nav").height(),i=s-a;e.load("lib/php/data/cases_conflicts_load.php",{case_id:t},function(){$("div.case_detail_panel_tools").css({height:a}),$("div.case_detail_panel_casenotes").css({height:i}),$("div.case_detail_panel_tools_left").css({width:"70%"}),$("div.case_detail_panel_tools_right").css({width:"30%"}),$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var e=$(this).scrollTop();0===e&&$(this).hasClass("csenote_shadow")?$(this).removeClass("csenote_shadow"):$(this).addClass("csenote_shadow")}),$("button.conflicts_print").button({icons:{primary:"fff-icon-printer"},text:!0}).click(function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Conflicts: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())})})});var phoneWidget='<p class="contact_phone_group"><label>Phone</label><select name="phone_type" class="contact_phone_type"><option value="mobile">mobile</option><option value="home">home</option><option value="office">office</option><option value="fax">fax</option><option value="other">other</option></select><input type="text" name="phone" class="contact_phone_value"><a href="#" class="add_phone">Add Another</a>',emailWidget='<p class="contact_email_group"><label>Email</label><select name="email_type"class="contact_email_type"><option value="work">work</option><option value="home">home</option><option value="other">other</option></select><input type="text" name="email" class="contact_email_value"><a href="#" class="add_email">Add Another</a>';$(".case_detail_nav #item6").live("click",function(){var e=$(this).closest(".case_detail_nav").siblings(".case_detail_panel"),t=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber"),a=$(this).outerHeight(),s=$(this).closest(".case_detail_nav").height(),i=s-a;e.load("lib/php/data/cases_contacts_load.php",{case_id:t},function(){$("div.case_detail_panel_tools").css({height:a}),$("div.case_detail_panel_casenotes").css({height:i}),$("div.case_detail_panel_tools_left").css({width:"30%"}),$("div.case_detail_panel_tools_right").css({width:"70%"}),$("button.new_contact").button({icons:{primary:"fff-icon-vcard-add"},text:!0}).next().button({icons:{primary:"fff-icon-printer"},text:!0}),$("div.csenote").addClass("ui-corner-all"),sizeContacts($(this).find(".contact"),e),$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var e=$(this).scrollTop();0===e&&$(this).hasClass("csenote_shadow")?$(this).removeClass("csenote_shadow"):$(this).addClass("csenote_shadow")})})}),$("div.contact_more").live("click",function(e){e.preventDefault();var t=$(this).closest(".contact"),a=$(this).closest(".contact").data("maxContactHeight"),s=$(this).closest(".contact").data("minContactHeight");"Less"===$(this).find("a").html()?(t.css({height:s}),$(this).find("a").html("More")):(t.css({height:a}),$(this).find("a").html("Less"))}),$(".case_detail_panel_tools_right button.new_contact").live("click",function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").scrollTop(0);var e=$(this).closest(".case_detail_panel_tools").siblings().find("div.new_contact");e.show(),$(this).closest(".case_detail_panel_tools").siblings().find("div.contact").not("div.csenote_new").css({opacity:".5"}),e.find('select[name = "contact_type"]').combobox(),$(this).closest(".case_detail_panel_tools").siblings().find("span.contact_phone_widget").html(phoneWidget),$(this).closest(".case_detail_panel_tools").siblings().find("span.contact_email_widget").html(emailWidget),$(this).closest(".case_detail_panel_tools").siblings().find("button.contact_action_cancel").click(function(t){t.preventDefault(),e.find("form")[0].reset(),e.find("span.first_name_live").html("New Contact"),e.find("span.last_name_live").html(""),e.find("span.contact_type_live").html(""),$(this).closest(".case_detail_panel_casenotes").find(".contact").css({opacity:"1"}),$(this).closest(".csenote_new").hide(),e.find('select[name = "contact_type"]').combobox("destroy")}),$(this).closest(".case_detail_panel_tools").siblings().find("button.contact_action_submit").click(function(t){t.preventDefault();var a=$(this).closest("form"),s=a.serializeArray(),i=validContact(s);if(i.length)notify(i,!0);else{var n={};a.find("p.contact_phone_group").each(function(){var e=$(this).find("select.contact_phone_type").val(),t=$(this).find("input.contact_phone_value").val();t.length&&(n[e]=t)});var o=JSON.stringify(n),l={};a.find("p.contact_email_group").each(function(){var e=$(this).find("select.contact_email_type").val(),t=$(this).find("input.contact_email_value").val();t.length&&(l[e]=t)});var c=JSON.stringify(l),d=$(this).closest(".case_detail_panel").data("CaseNumber"),r=$(this).closest(".case_detail_panel_casenotes");e.find('select[name = "contact_type"]').combobox("destroy"),$.post("lib/php/data/cases_contacts_process.php",{first_name:a.find('input[name = "first_name"]').val(),last_name:a.find('input[name = "last_name"]').val(),organization:a.find('input[name = "organization"]').val(),contact_type:a.find('select[name = "contact_type"]').val(),address:a.find('textarea[name = "address"]').val(),city:a.find('input[name = "city"]').val(),state:a.find('select[name = "state"]').val(),zip:a.find('input[name = "zip"]').val(),phone:o,email:c,url:a.find('input[name = "url"]').val(),notes:a.find('textarea[name = "notes"]').val(),action:"add",case_id:d},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),r.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:d}),checkConflicts(d))})}})}),$(".case_detail_panel_tools_right button.contact_print").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Contacts: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())}),$("#contact_first_name").live("keyup",function(){$(this).closest(".new_contact").find("span.first_name_live").html($(this).val())}),$("#contact_last_name").live("keyup",function(){$(this).closest(".new_contact").find("span.last_name_live").html($(this).val())}),$("#contact_type").live("change",function(){$(this).closest(".new_contact").find("span.contact_type_live").html($(this).val())}),$("#contact_first_name").live("focus",function(){$(this).closest(".new_contact").find("span.first_name_live").html(""),$("#contact_first_name").die("focus")}),$("#contact_organization").live("focus",function(){""===$("#contact_first_name").val()&&""===$("#contact_last_name").val()&&($(this).keyup(function(){$(this).closest(".new_contact").find("span.first_name_live").html($(this).val())}),$(this).focusout().die("keyup"))}),$("input.contacts_search").live("focusin",function(){$(this).val(""),$(this).css({color:"black"}),$(this).next(".contacts_search_clear").show()}),$("input.contacts_search").live("keyup",function(){var e=$(this).closest("div.case_detail_panel_tools").next(),t=$(this).val(),a=$(this).closest(".case_detail_panel").data("CaseNumber");e.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:a,q:t},function(){e.scrollTop(0),t.length&&e.highlight(t),sizeContacts($(".contact"),e),e.hasClass("csenote_shadow")&&e.removeClass("csenote_shadow"),$("div.contact").addClass("ui-corner-all"),e.bind("scroll.search",function(){$(this).scrollTop()>0?$(this).addClass("csenote_shadow"):$(this).removeClass("csenote_shadow")})})}),$(".contacts_search_clear").live("click",function(){$(this).prev().val("Search Contacts"),$(this).prev().css({color:"#AAA"});var e=$(this).closest("div.case_detail_panel_tools").next(),t=$(this).closest(".case_detail_panel").data("CaseNumber");e.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:t},function(){e.scrollTop(0),sizeContacts($(".contact"),e),$("div.csenote").addClass("ui-corner-all"),e.unbind("scroll.search"),e.bind("scroll",function(){addMoreNotes(e)})}),$(this).hide()}),$("a.contact_edit").live("click",function(e){if(e.preventDefault(),$(this).closest(".case_detail_panel_casenotes").find(".contact_edit_submit").length)return notify("Only one contact can be edited at a time",!0),!1;var t,a=$(this).closest(".contact"),s=a.find(".cnt_first_name").html(),i=a.find(".cnt_last_name").html(),n=a.find(".cnt_type").html(),o=a.find(".cnt_organization").html(),l=a.find(".cnt_address").html(),c=a.find(".cnt_city").html(),d=a.find(".cnt_state").html(),r=a.find(".cnt_zip").html(),_=a.find(".cnt_url").html(),p=a.find(".cnt_notes").html();t=null!==p?p.br2nl():"";var h=a.attr("data-id"),u=$(this).closest("div.contact").siblings("div.new_contact").clone().addClass("contact_edit");a.after(u),a.offset().top,s||i?(u.find("span.first_name_live").html(s),u.find("span.last_name_live").html(i)):u.find("span.first_name_live").html(o),u.find("span.contact_type_live").html(n),u.find('input[name = "first_name"]').val(s),u.find('input[name = "last_name"]').val(i),u.find('input[name = "organization"]').val(o),u.find('select[name = "contact_type"]').val(n),u.find('textarea[name = "address"]').html(l),u.find('input[name = "city"]').val(c),u.find('select[name = "state"]').val(d),u.find('input[name = "zip"]').val(r),u.find('input[name = "url"]').val(_),u.find('textarea[name = "notes"]').val(t);var f={};a.find("p.contact_phone_group").each(function(){var e=$(this).find("span.contact_phone_type").text().trim(),t=$(this).find("span.contact_phone_value").text().trim();f[e]=t});var v="";$.isEmptyObject(f)?v='<p class="contact_phone_group"><label>Phone</label><select name="phone_type"class="contact_phone_type"><option value="mobile">mobile</option><option value="home">home</option><option value="office">office</option><option value="fax">fax</option></select><input type="text" name="phone" class="contact_phone_value">':$.each(f,function(e){doEditSelect(e,"phone"),v+='<p class="contact_phone_group"><label>Phone</label><select name="phone_type"class="contact_phone_type">" + phoneOptions + "</select><input type="text" name="phone"class="contact_phone_value" value="" + value + "">'}),u.find("span.contact_phone_widget").html(v),u.find("span.contact_phone_widget").find(".contact_phone_group input").last().after('<a href="#" class="add_phone">Add Another</a>');var m={};a.find("p.contact_email_group").each(function(){var e=$(this).find("span.contact_email_type").text().trim(),t=$(this).find("span.contact_email_value").text().trim();m[e]=t});var b="";$.isEmptyObject(m)?b='<p class="contact_email_group"><label>Email</label><select name="email_type"class="contact_email_type"><option value="work">work</option><option value="home">home</option><option value="other">other</option></select><input type="text" name="email" class="contact_email_value">':$.each(m,function(e){var t=doEditSelect(e,"email");b+='<p class="contact_email_group"><label>Email</label><select name="email_type" class="contact_email_type">'+t+'</select><input type="text" name="email" '+'class="contact_email_value" value="" + value + "">'}),u.find("span.contact_email_widget").html(b),u.find("span.contact_email_widget").find(".contact_email_group input").last().after('<a href="#" class="add_email">Add Another</a>'),u.find(".csenote_bar").css({"background-color":"#FEBBBB"}),u.find("button.contact_action_submit").html("Done").addClass("contact_edit_submit").removeClass("contact_action_submit"),u.find("button.contact_action_cancel").addClass("contact_edit_cancel").removeClass("contact_action_cancel"),u.find('select[name = "contact_type"]').combobox(),u.show(),a.hide(),u.find("button.contact_edit_cancel").click(function(e){e.preventDefault(),u.hide().remove(),a.show()}),u.find("button.contact_edit_submit").click(function(e){e.preventDefault();var t=$(this).closest("form"),a=t.serializeArray(),s=validContact(a);if(s.length)notify(s,!0);else{var i={};t.find("p.contact_phone_group").each(function(){var e=$(this).find("select.contact_phone_type").val(),t=$(this).find("input.contact_phone_value").val();i[e]=t});var n=JSON.stringify(i),o={};t.find("p.contact_email_group").each(function(){var e=$(this).find("select.contact_email_type").val(),t=$(this).find("input.contact_email_value").val();o[e]=t});var l=JSON.stringify(o),c=$(this).closest(".case_detail_panel").data("CaseNumber"),d=$(this).closest(".case_detail_panel_casenotes");t.find('select[name = "contact_type"]').combobox("destroy"),$.post("lib/php/data/cases_contacts_process.php",{first_name:t.find('input[name = "first_name"]').val(),last_name:t.find('input[name = "last_name"]').val(),organization:t.find('input[name = "organization"]').val(),contact_type:t.find('select[name = "contact_type"]').val(),address:t.find('textarea[name = "address"]').val(),city:t.find('input[name = "city"]').val(),state:t.find('select[name = "state"]').val(),zip:t.find('input[name = "zip"]').val(),phone:n,email:l,url:t.find('input[name = "url"]').val(),notes:t.find('textarea[name = "notes"]').val(),action:"edit",case_id:c,id:h},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),d.load("lib/php/data/cases_contacts_load.php div.case_detail_panel_casenotes",{case_id:c},function(){sizeContacts(d.find(".contact"),d);var e=d.find('div.contact[data-id = "'+h+'"]');d.scrollTop(e.offset().top),checkConflicts(c)}))})}})}),$("a.contact_delete").live("click",function(e){e.preventDefault();var t=$(this).closest(".contact"),a=t.attr("data-id"),s=$('<div class=".dialog-casenote-delete" title="Delete this Contact?">This contactwill be permanently deleted.  Are you sure?</div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/cases_contacts_process.php",{action:"delete",id:a},function(e){var a=$.parseJSON(e);a.error===!0?notify(a.message,!0):(notify(a.message),t.remove())}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(s).dialog("open")}),$(".add_email").live("click",function(e){e.preventDefault(),$(this).closest("p").after(emailWidget),$(this).remove()}),$(".add_phone").live("click",function(e){e.preventDefault(),$(this).closest("p").after(phoneWidget),$(this).remove()}),$(".case_detail_nav #item3").live("click",function(){var e=$(this).closest(".case_detail_nav").siblings(".case_detail_panel"),t=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber"),a=$(this).outerHeight(),s=$(this).closest(".case_detail_nav").height(),i=s-a;e.data("CurrentPath","Home"),e.load("lib/php/data/cases_documents_load.php",{id:t},function(){$("div.case_detail_panel_tools").css({height:a}),$("div.case_detail_panel_casenotes").css({height:i}),$("div.case_detail_panel_tools_left").css({width:"40%"}),$("div.case_detail_panel_tools_right").css({width:"60%"}),$("button.doc_new_doc").button({icons:{primary:"fff-icon-page-add"},text:!0}).next().button({icons:{primary:"fff-icon-folder-add"},text:!0}).next().button({icons:{primary:"fff-icon-page-white-get"},text:!0}),unescapeNames(),$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var e=$(this).scrollTop();0===e&&$(this).hasClass("csenote_shadow")?$(this).removeClass("csenote_shadow"):$(this).addClass("csenote_shadow")}),createDragDrop()}),$("div.doc_item").contextMenu({menu:"docMenu"},function(e,t){var a=$(t).attr("data-id"),s=null,i=$(t).closest(".case_detail_panel").data("CaseNumber");$(t).find("p").html();var n,o=$(t).closest(".case_detail_panel_casenotes").siblings(".case_detail_panel_tools").find(".path_display");switch($(t).hasClass("folder")?(s="folder",n=$(t).attr("path")):(s="document",n=""),e){case"open":openItem(t,a,s,i,n,o);break;case"cut":$(t).css({opacity:".5"});var l=[a,s,n,i];$(t).closest(".case_detail_panel_casenotes").data("cutValue",l),$("div.case_detail_panel_casenotes").contextMenu({menu:"docMenu_copy_paste"},function(e,t){if("paste"===e){var a=t.data("cutValue")[3],s=t.data("cutValue")[1],i=t.closest(".case_detail_panel").data("CurrentPath");"Home"===i&&(i="");var n=t.data("cutValue")[0],o=t.data("cutValue")[2];$.post("lib/php/data/cases_documents_process.php",{action:"cut",item_id:n,target_path:i,selection_path:o,doc_type:s,case_id:a},function(e){var s=$.parseJSON(e);notify(s.message),t.closest(".case_detail_panel_casenotes").load("lib/php/data/cases_documents_load.php",{id:a,update:"yes",path:i,container:i},function(){unescapeNames(),t.destroyContextMenu()})})}});break;case"copy":if("folder"===s)notify("Sorry, copying of folders is not supported.",!0);else{$(t).css({border:"1px solid #AAA"});var c=[a,s,n,i];$(t).closest(".case_detail_panel_casenotes").data("copyValue",c),$("div.case_detail_panel_casenotes").contextMenu({menu:"docMenu_copy_paste"},function(e,t){if("paste"===e){var a=t.data("copyValue")[3],s=t.data("copyValue")[1];t.data("copyValue")[2];var i=t.closest(".case_detail_panel").data("CurrentPath");"Home"===i&&(i="");var n=t.data("copyValue")[0];$.post("lib/php/data/cases_documents_process.php",{action:"copy",item_id:n,target_path:i,doc_type:s,case_id:a},function(e){var s=$.parseJSON(e);notify(s.message),t.closest(".case_detail_panel_casenotes").load("lib/php/data/cases_documents_load.php",{id:a,update:"yes",path:i,container:i},function(){unescapeNames(),t.destroyContextMenu()})})}})}break;case"rename":var d=$(t).find("p").html(),r=function(e){var o=escape($.trim($(t).find("textarea").val()));""!==o&&$.post("lib/php/data/cases_documents_process.php",{action:"rename",new_name:o,item_id:a,doc_type:s,path:n,case_id:i},function(a){var s=$.parseJSON(a);return s.error?(notify(s.message),void 0):($(t).find("textarea").hide(),$(t).find("p").html(unescape(o)),$(t).attr("path",s.newPath),$(t).find("p").show(),notify(s.message),e(),void 0)})};$(t).find("p").hide(),1>$(t).find("textarea").length?$(t).find("p").after("<br /><textarea>"+d+"</textarea>"):$(t).find("textarea").show().val(d),$(t).find("textarea").addClass("user_input").focus().select().blur(function(){r(function(){$(t).find("textarea").hide(),$(t).find("p").show(),$(t).find("textarea").unbind("blur keypress")})}).click(function(e){e.stopPropagation()}).keypress(function(e){e.stopPropagation(),13===e.which&&r(function(){$(t).find("textarea").unbind("keypress blur")})});break;case"delete":var _=null;_=$(t).hasClass("folder")?"This folder and all of its contents will be permanently deleted from the server.Are you sure?":"This item will be permanently deleted from the server.  Are you sure?";var p=$('<div class=".dialog-casenote-delete" title="Delete this Item?">'+_+"</div>").dialog({autoOpen:!0,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/cases_documents_process.php",{action:"delete",item_id:a,doc_type:s,path:n,case_id:i},function(e){var a=$.parseJSON(e);notify(a.message),$(t).remove(),p.dialog("destroy")})},No:function(){$(this).dialog("destroy")}}});break;case"properties":$(t).css({border:"1px solid #AAA"}).next(".doc_properties").addClass("ui-corner-all").css({top:"20%",left:"30%"}).show().focus().focusout(function(){$(this).hide(),$(t).css({border:"0px"})})}}),$("div.doc_item").live("mouseenter",function(){$(this).closest("div").css({height:"auto",overflow:"auto"})}),$("div.doc_item").live("mouseleave",function(){$(this).closest("div").css({height:"120px",overflow:"hidden"})})}),$("div.doc_item").live("click",function(e){e.preventDefault();var t=$(this).attr("path"),a=$(this).closest(".case_detail_panel").data("CaseNumber"),s=$(this).closest(".case_detail_panel_casenotes").siblings(".case_detail_panel_tools").find(".path_display"),i=$(this),n=i.attr("data-id"),o="document";openItem(i,n,o,a,t,s)}),$("button.doc_new_doc").live("click",function(){var e=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");createTextEditor(e,"new","yes","New Document",null,null,"1","yes")}),$("button.doc_new_folder").live("click",function(){var e=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");$("span.docs_empty")&&$("span.docs_empty").remove(),e.prepend('<div class="doc_item folder" path="" data-id=""><img src="html/ico/folder.png"><p><textarea id="new_folder_name">New Folder</textarea></p></div>'),$("#new_folder_name").select(),$("#new_folder_name").addClass("user_input").mouseenter(function(){$(this).val("").focus().css({"background-color":"white"})}).bind("blur keyup",function(e){if("blur"===e.type||13===e.which){e.preventDefault();var t=$(this).closest(".case_detail_panel_casenotes").siblings(".case_detail_panel_tools").find("a.active").attr("path"),a=$(this).closest(".case_detail_panel").data("CaseNumber"),s=$("#new_folder_name").val();if(-1!==s.indexOf("/"))return notify("Sorry, folder names cannot contain a foward slash.",!0),!1;if("\n"===s)return notify("Please provde a name for your folder.",!0),!1;var i=null;i=""===t||t===void 0?escape($.trim(s.replace(/[\n\r]$/,""))):t+"/"+escape($.trim(s.replace(/[\n\r]$/,""))),$.post("lib/php/data/cases_documents_process.php",{case_id:a,container:t,new_folder:i,action:"newfolder"},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):($("#new_folder_name").parent().siblings("img").wrap('<a href="#" />'),$("#new_folder_name").closest(".folder").attr({path:i,"data-id":t.id}).droppable(),$("#new_folder_name").closest("p").html(s),createDragDrop(),notify(t.message))})}})}),$("button.doc_upload").live("click",function(){var e=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes"),t=$(this).closest(".case_detail_panel").data("CaseNumber");$("span.docs_empty")&&$("span.docs_empty").remove();var a=$(this).parent().siblings().find("a.active").text();""===a&&(a="Home");var s=$(this).closest(".case_detail_panel").data("CurrentPath");"Home"===s&&(s=""),$(document).find(".upload_dialog").dialog({height:500,width:500,modal:!0,title:"Upload into "+a+" folder:",open:function(){$(this).find("div.upload_dialog_url").show(),$(this).find("div.upload_dialog_file").show(),$(this).find("div.upload_url_form").hide()},close:function(){$(this).dialog("destroy")}}),new qq.FileUploader({element:$(".upload_dialog_file")[0],action:"lib/php/utilities/file_upload.php",params:{path:s,case_id:t},onComplete:function(){e.load("lib/php/data/cases_documents_load.php",{id:t,update:"yes",path:s,container:s},function(){createDragDrop(),unescapeNames()})}}),$("div.qq-upload-button").addClass("ui-corner-all").click(function(){$(this).closest(".upload_dialog_file").siblings("div.upload_dialog_url").hide()}),$(".upload_url_button").mouseenter(function(){$(this).addClass("qq-upload-button-hover")}).mouseleave(function(){$(this).removeClass("qq-upload-button-hover")}).click(function(){$(this).siblings(".upload_url_form").show(),$(this).parents(".upload_dialog_url").siblings(".upload_dialog_file").hide()}),$("button.upload_url_submit").unbind("click").click(function(){var a=$(this).siblings("input.url_upload").val(),i=$(this).siblings("input.url_upload_name").val();return isUrl(a)===!1?($(document).find("p.upload_url_form_error_url").html("Sorry, your URL is invalid.  It must begin with http://, https:// or ftp://"),$(this).siblings("input.url_upload").focus(function(){$(document).find("p.upload_url_form_error_url").html("")}),!1):""===i?($(document).find("p.upload_url_form_error_name").html("Please give this URL a title."),$(this).siblings("input.url_upload_name").focus(function(){$(document).find("p.upload_url_form_error_name").html("")}),!1):($.post("lib/php/data/cases_documents_process.php",{url_name:i,url:a,case_id:t,path:s,action:"add_url"},function(a){var i=$.parseJSON(a);$(".upload_dialog").find("p.upload_url_notify").show().html(i.message).fadeOut("slow",function(){$(this).html("")}),$(".upload_dialog").find("input").val(""),e.load("lib/php/data/cases_documents_load.php",{id:t,update:"yes",path:s,container:s},function(){unescapeNames()})}),void 0)})}),$("a.doc_trail_home").live("click",function(e){e.preventDefault();var t=$(this).closest(".case_detail_panel").data("CaseNumber"),a=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");$(this).closest(".case_detail_panel").data("CurrentPath","Home"),a.load("lib/php/data/cases_documents_load.php",{id:t,update:"yes"},function(){$(this).siblings(".case_detail_panel_tools").find(".path_display").html(""),unescapeNames(),createDragDrop()})}),$("a.doc_trail_item").live("click",function(e){e.preventDefault(),$(this).html();var t=$(this).attr("path"),a=$(this).closest(".case_detail_panel").data("CaseNumber");$(this).closest(".case_detail_panel").data("CurrentPath",t);var s=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes"),i=$(this).parent();s.load("lib/php/data/cases_documents_load.php",{id:a,update:"yes",path:t,container:t},function(){$(this).siblings(".case_detail_panel_tools").find(".path_display").html("");var e=createTrail(t);i.html(e),i.find("a[path='"+t+"']").addClass("active"),unescapeNames(),$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var e=$(this).scrollTop();0===e&&$(this).hasClass("csenote_shadow")?$(this).removeClass("csenote_shadow"):$(this).addClass("csenote_shadow")}),createDragDrop()})}),$('select[name="ccd_permission"]').live("change",function(){var e=$(this).val(),t=$(this).closest(".text_editor_bar").attr("data-id");$.post("lib/php/data/cases_documents_process.php",{action:"change_ccd_permissions",ccd_id:t,ccd_lock:e},function(e){var t=$.parseJSON(e);notify(t.message)})}),$(".case_detail_nav #item4").live("click",function(){var e=$(this).closest(".case_detail_nav").siblings(".case_detail_panel"),t=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber"),a=$(this).outerHeight(),s=$(this).closest(".case_detail_nav").height(),i=s-a;e.load("lib/php/data/cases_events_load.php",{case_id:t},function(){$("div.case_detail_panel_tools").css({height:a}),$("div.case_detail_panel_casenotes").css({height:i}),$("div.case_detail_panel_tools_left").css({width:"30%"}),$("div.case_detail_panel_tools_right").css({width:"70%"}),$("button.new_event").button({icons:{primary:"fff-icon-calendar-add"},text:!0}).next().button({icons:{primary:"fff-icon-printer"},text:!0}),$("div.csenote").addClass("ui-corner-all"),$(this).children(".case_detail_panel_casenotes").bind("scroll",function(){var e=$(this).scrollTop();0===e&&$(this).hasClass("csenote_shadow")?$(this).removeClass("csenote_shadow"):$(this).addClass("csenote_shadow")})})}),$(".case_detail_panel_tools_right button.new_event").live("click",function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").scrollTop(0);var e=$(this).closest(".case_detail_panel_tools").siblings().find("div.new_event");e.show(),$(this).closest(".case_detail_panel_tools").siblings().find("div.event").not("div.csenote_new").css({opacity:".5"}),e.find('input[name="start"]').datetimepicker({ampm:!0,stepHours:1,stepMinute:5,hour:9,minute:0,onSelect:function(t){e.find('input[name="end"]').datetimepicker("setDate",t)}}),e.find('input[name="end"]').datetimepicker({ampm:!0,stepHours:1,stepMinute:5,hour:9,minute:0}),e.find('select[name="responsibles"]').chosen(),$(this).closest(".case_detail_panel_tools").siblings().find("button.event_action_cancel").click(function(t){t.preventDefault(),e.find("form")[0].reset(),e.find("span.event_name_live").html("New Event"),e.find("select option").filter(function(){return"You"===this.text}).attr("selected",!0),e.find("select").trigger("liszt:updated"),$(this).closest(".case_detail_panel_casenotes").find(".event").css({opacity:"1"}),$(this).closest(".new_event").hide()}),$(this).closest(".case_detail_panel_tools").siblings().find("button.event_action_submit").click(function(e){e.preventDefault();var t=$(this).closest("form"),a=t.serializeArray(),s=t.find('select[name="responsibles"]').val(),i=$.extend({},s);a.unshift(i);var n=validEvent(a);if(n.length)notify(n,!0);else{var o=$(this).closest(".case_detail_panel").data("CaseNumber"),l=$(this).closest(".case_detail_panel_casenotes");$.post("lib/php/data/cases_events_process.php",{task:t.find('input[name = "task"]').val(),where:t.find('input[name = "where"]').val(),start:t.find('input[name = "start"]').val(),end:t.find('input[name = "end"]').val(),all_day:t.find('input[name = "all_day"]').val(),notes:t.find('textarea[name = "notes"]').val(),responsibles:s,action:"add",case_id:o},function(e){var t=$.parseJSON(e);
t.error===!0?notify(t.message,!0):(notify(t.message),l.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:o}))})}})}),$('input[name="task"]').live("keyup",function(){$(this).closest(".new_event").find("span.event_name_live").html($(this).val())}),$("input.events_search").live("focusin",function(){$(this).val(""),$(this).css({color:"black"}),$(this).next(".events_search_clear").show()}),$("input.events_search").live("keyup",function(){var e=$(this).closest("div.case_detail_panel_tools").next(),t=$(this).val(),a=$(this).closest(".case_detail_panel").data("CaseNumber");e.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:a,q:t},function(){e.scrollTop(0),t.length&&e.highlight(t),e.hasClass("csenote_shadow")&&e.removeClass("csenote_shadow"),$("div.event").addClass("ui-corner-all"),e.bind("scroll.search",function(){$(this).scrollTop()>0?$(this).addClass("csenote_shadow"):$(this).removeClass("csenote_shadow")})})}),$(".events_search_clear").live("click",function(){$(this).prev().val("Search Events"),$(this).prev().css({color:"#AAA"});var e=$(this).closest("div.case_detail_panel_tools").next(),t=$(this).closest(".case_detail_panel").data("CaseNumber");e.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:t},function(){e.scrollTop(0),$("div.event").addClass("ui-corner-all")}),$(this).hide()}),$("a.event_delete").live("click",function(e){e.preventDefault();var t=$(this).closest(".event"),a=t.attr("data-id"),s=$('<div class=".dialog-casenote-delete" title="Delete this Event?">This eventwill be permanently deleted.  Are you sure?</div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/cases_events_process.php",{action:"delete",event_id:a},function(e){var a=$.parseJSON(e);a.error===!0?notify(a.message,!0):(notify(a.message),t.remove())}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(s).dialog("open")}),$(".case_detail_panel_tools_right button.events_print").live("click",function(){elPrint($(this).closest("div.case_detail_panel_tools").siblings("div.case_detail_panel_casenotes"),"Case Data: "+$(this).closest(".case_detail_panel").siblings(".case_detail_bar").find(".case_title").text())}),$("a.event_edit").live("click",function(e){if(e.preventDefault(),$(this).closest(".case_detail_panel_casenotes").find(".event_edit_submit").length)return notify("Only one event can be edited at a time",!0),!1;var t,a=$(this).closest(".event"),s=a.attr("data-id"),i=a.find("span.event_task_title").html(),n=a.find("span.event_start").html(),o=a.find("span.event_end").html(),l=a.find("span.event_location").html(),c=a.find("span.event_notes").html();a.find("span.event_all_day").length&&(t="on");var d=[];a.find("span.user_identifier").each(function(){d.push($(this).attr("data"))});var r=$(this).closest("div.event").siblings("div.new_event").clone().addClass("event_edit");a.after(r);var _=a.offset().top;r.find("span.event_name_live").html(i),r.find('input[name="task"]').val(i),r.find('input[name="where"]').val(l),r.find('input[name="end"]').val(o),r.find('textarea[name="notes"]').val(c),r.find('select[name="responsibles"]').val(d);var p=r.find('input[name="start"]').datetimepicker({ampm:!0,stepHours:1,stepMinute:5});p.datetimepicker("setDate",new Date(n));var h=r.find('input[name="end"]').datetimepicker({ampm:!0,stepHours:1,stepMinute:5});h.datetimepicker("setDate",new Date(o)),r.find('select[name="responsibles"]').chosen(),r.find("div.chzn-container, div.chzn-drop").css({width:"150px"}),r.find(".csenote_bar").css({"background-color":"#FEBBBB"}),r.find("button.event_action_submit").html("Done").addClass("event_edit_submit").removeClass("event_action_submit"),r.find("button.event_action_cancel").addClass("event_edit_cancel").removeClass("event_action_cancel"),r.show(),a.hide(),r.find("button.event_edit_cancel").click(function(e){e.preventDefault(),r.hide().remove(),a.show()}),r.find("button.event_edit_submit").click(function(e){e.preventDefault();var t=$(this).closest("form"),a=t.serializeArray(),i=r.find('select[name="responsibles"]').val(),n=$.extend({},i);a.unshift(n);var o=validEvent(a);if(o.length)notify(o,!0);else{var l=$(this).closest(".case_detail_panel").data("CaseNumber"),c=$(this).closest(".case_detail_panel_casenotes");$.post("lib/php/data/cases_events_process.php",{task:t.find('input[name = "task"]').val(),where:t.find('input[name = "where"]').val(),start:t.find('input[name = "start"]').val(),end:t.find('input[name = "end"]').val(),all_day:t.find('input[name = "all_day"]').val(),notes:t.find('textarea[name = "notes"]').val(),responsibles:i,action:"edit",case_id:l,event_id:s},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),c.load("lib/php/data/cases_events_load.php div.case_detail_panel_casenotes",{case_id:l},function(){c.find('div.contact[data-id = "'+s+'"]'),c.scrollTop(_)}))})}})}),$(".case_detail_nav #item5").live("click",function(){var e=$(this).closest(".case_detail_nav").siblings(".case_detail_panel").data("CaseNumber"),t=$(this).closest(".case_detail_nav").siblings(".case_detail_panel");t.find(".case_detail_panel_casenotes");var a=$(this).outerHeight(),s=$(this).closest(".case_detail_nav").height(),i=s-a;t.load("lib/php/data/cases_messages_load.php",{type:"main",case_id:e,start:"0"},function(){$("div.case_detail_panel_tools").css({height:a}),$("div.case_detail_panel_casenotes").css({height:i}),$("div.case_detail_panel_tools_left").css({width:"30%"}),$("div.case_detail_panel_tools_right").css({width:"70%"}),$("button.cse_new_msg").button({icons:{primary:"fff-icon-email-go"},text:!0}).click(function(){$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes").load("lib/php/data/cases_messages_load.php #msg_new",{new_message:"y",case_id:e},function(){$(this).unbind("scroll.msg"),$(this).hasClass("csenote_shadow")&&$(this).removeClass("csenote_shadow");var e=$("div#msg_new");e.show(),e.find('select[name = "new_tos[]"], select[name = "new_ccs[]"], select[name = "new_file_msg"]').chosen(),$("#msg_new_button_cancel").click(function(e){e.preventDefault(),$("#new_msg_form")[0].reset(),$(this).closest(".case_detail_panel").siblings(".case_detail_nav").find("li#item5").trigger("click"),$(this).bind("scroll.msg"),notify("New message cancelled")}),$("#msg_new_button_submit").click(function(e){e.preventDefault();var t=$("#new_msg_form").serializeArray(),a=$(this).closest(".case_detail_panel").siblings(".case_detail_nav").find("li#item5");return null===$('select[name="new_tos"]').val()?(notify("<p>You must select at least one recipient</p>"),!1):($.post("lib/php/data/messages_process.php",t,function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):($("#new_msg_form")[0].reset(),a.trigger("click"),notify("Message sent"),$(this).bind("scroll.msg"))}),void 0)})})}),layoutMessages(),t.data("searchOn","n"),$(this).children(".case_detail_panel_casenotes").bind("scroll.msg",function(){var a=$(this).scrollTop();if(0===a&&$(this).hasClass("csenote_shadow"))$(this).removeClass("csenote_shadow");else{$(this).addClass("csenote_shadow");var s=null;s="y"===t.data("searchOn")?"search":"main",addMoreMessages($(this),s,e)}})})}),$("div.msg_bar").live("click",function(){var e=$(this).parent(),t=$(this).closest(".case_detail_panel");if($(this).parent().hasClass("msg_closed")){e.removeClass("msg_closed").addClass("msg_opened"),e.find("p.tos, p.ccs, p.subj").css({color:"black"}),e.css({opacity:"1"});var a=e.attr("data-id");$(this).next("div").find("div.msg_replies").load("lib/php/data/cases_messages_load.php",{type:"replies",thread_id:a},function(){var a=$(this).closest("div.msg")[0].scrollHeight;if(e.animate({height:a}),"y"===t.data("searchOn")){var s=$(this).closest(".case_detail_panel");t.highlight(s.data("searchTerm"))}}),$.post("lib/php/data/messages_process.php",{action:"mark_read",id:a})}else e.removeClass("msg_opened").addClass("msg_closed"),e.find("div.msg_reply_text").hide().find("textarea").val(""),e.find("div.msg_forward").hide(),e.css({opacity:".5"}),e.animate({height:"90"})}),$("span.star_msg").live("click",function(e){e.stopPropagation();var t=$(this).closest("div.msg").attr("data-id");$(this).hasClass("star_off")?($(this).removeClass("star_off").addClass("star_on"),$(this).html('<img src = "html/ico/starred.png">'),$.post("lib/php/data/messages_process.php",{action:"star_on",id:t},function(e){var t=$.parseJSON(e);t.error===!0&&notify(t.message,!0)})):($(this).removeClass("star_on").addClass("star_off"),$(this).html('<img src = "html/ico/not_starred.png">'),$.post("lib/php/data/messages_process.php",{action:"star_off",id:t},function(e){var t=$.parseJSON(e);t.error===!0&&notify(t.message,!0)}))}),$("div.msg_actions a").live("click",function(e){e.preventDefault();var t=$(this).attr("class"),a=null;"forward"===t&&(a=$(this).closest("div.msg").height()+300,$(this).parent().siblings("div.msg_forward").show().find("select").chosen(),$(this).closest("div.msg").height(a),$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(t)),"reply"===t&&(a=$(this).closest("div.msg").height()+250,$(this).closest("div.msg").height(a),$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(t))}),$("a.print").live("click",function(){alert("Working on it")}),$("p.msg_to_more").live("click",function(e){e.preventDefault();var t,a;if($(this).hasClass("ex_tos")){var s=$(this).siblings("p.tos");t=s[0].scrollHeight,$(this).hasClass("expanded")?($(this).removeClass("expanded"),s.css({height:"20"}),$(this).html('<a href="#">and others</a>'),a=$(this).closest("div.msg").height()-t,$(this).closest("div.msg").height(a)):(s.css({height:t}),$(this).addClass("expanded"),$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>'),a=$(this).closest("div.msg").height()+t,$(this).closest("div.msg").height(a))}else{var i=$(this).siblings("p.ccs");t=i[0].scrollHeight,$(this).hasClass("expanded")?($(this).removeClass("expanded"),i.css({height:"20"}),$(this).html('<a href="#">and others</a>'),a=$(this).closest("div.msg").height()-t,$(this).closest("div.msg").height(a)):(i.css({height:t}),$(this).addClass("expanded"),$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>'),a=$(this).closest("div.msg").height()+t,$(this).closest("div.msg").height(a))}}),$("input.cse_msg_search").live("focusin",function(){$(this).val(""),$(this).css({color:"black"}),$(this).next(".cse_msg_search_clear").show()}),$("input.cse_msg_search").live("keyup",function(e){if(13===e.which&&$(this).val().length){var t=$(this).closest(".case_detail_panel"),a=t.data("CaseNumber"),s=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");t.data("startVal","0"),t.data("searchOn","y"),t.data("searchTerm",$(this).val()),s.html("<p>Searching...</p>");var i=$(this).val();s.load("lib/php/data/cases_messages_load.php",{type:"search",start:"0",s:i,case_id:a},function(){s.scrollTop(0),layoutMessages(),s.highlight(i)})}}),$(".cse_msg_search_clear").live("click",function(){var e=$(this).closest(".case_detail_panel"),t=$(this).closest(".case_detail_panel_tools").siblings(".case_detail_panel_casenotes");t.html("<p>Loading...</p>"),e.data("searchOn","n"),e.data("searchTerm",""),e.data("startVal",0),$(this).prev().val("Search Messages"),$(this).prev().css({color:"#AAA"}),$(this).closest(".case_detail_panel").siblings(".case_detail_nav").find("li#item5").trigger("click"),t[0].scrollTop=0,$(this).hide()}),$("button.msg_send").live("click",function(){var e=$(this).prev().val(),t=$(this).closest("div.msg").attr("data-id"),a=$(this).prev().attr("class"),s=$(this).parent().siblings("div.msg_replies"),i=$(this).closest("div.msg"),n=$(this).parent().siblings("div.msg_forward").find("select").val();$.post("lib/php/data/messages_process.php",{action:a,thread_id:t,reply_text:e,forward_tos:n},function(e){var a=$.parseJSON(e);a.error===!0?notify(a.message,!0):(notify(a.message),s.load("lib/php/data/cases_messages_load.php",{type:"replies",thread_id:t},function(){i.animate({height:"90"}),i.removeClass("msg_read msg_opened").addClass("msg_unread msg_closed"),i.find("div.msg_reply_text").hide().find("textarea").val(""),i.find("div.msg_forward").hide(),i.find("div.msg_forward select").val(""),$(this).closest(".case_detail_panel_casenotes").scrollTop(i.data("verticalPos"))}))})});var oTable,aoColumns;$(document).ready(function(){function e(){var e=oTable.fnSettings();for(iCol=0;e.aoPreSearchCols.length>iCol;iCol++)e.aoPreSearchCols[iCol].sSearch="";oTable.fnFilter(""),ColReorder.fnReset(oTable),$("input").each(function(){this.value=""}),$("select").each(function(){this.selectedIndex="0"}),$("#addOpenRow, #addCloseRow").each(function(){$(this).text("Add Condition")}),$("#second_open_cell, #second_close_cell").css({visibility:"hidden"}),$("thead tr.advanced_2").hide("slow"),oTable.fnFilter("^$",oTable.fnGetColumnIndex("Date Close"),!0,!1),t="open",oTable.fnSort([[oTable.fnGetColumnIndex("Last Name"),"asc"]]),oTable.fnDraw()}var t="open";$.ajax({url:"lib/php/data/cases_columns_load.php",dataType:"json",error:function(){return alert("Sorry, there is an error in your ClinicCases configuration"),!0},success:function(a){a&&(aoColumns=a.aoColumns,oTable=$("#table_cases").dataTable({bJQueryUI:!0,bProcessing:!0,bScrollInfinite:!0,bScrollCollapse:!0,bSortCellsTop:!0,bStateSave:!0,iCookieDuration:31536e3,sScrollY:adjustedHeight-95,iDisplayLength:50,aaSorting:[[4,"asc"]],aoColumns:aoColumns,sDom:"R<'H'fTCi>rt",oColVis:{aiExclude:[0,6,7],bRestore:!0,buttonText:"Columns",fnStateChange:function(e){$("div.dataTables_scrollHeadInner thead th.addSelects:empty").each(function(){this.innerHTML=fnCreateSelect(oTable.fnGetColumnData(e,!0,!1,!0))})}},oTableTools:{sSwfPath:"lib/DataTables-1.8.2/extras/TableTools/media/swf/copy_cvs_xls_pdf.swf",aButtons:[{sExtends:"collection",sButtonText:"Print/Export",aButtons:[{sExtends:"copy",mColumns:"visible"},{sExtends:"csv",mColumns:"visible"},{sExtends:"xls",mColumns:"visible"},{sExtends:"pdf",mColumns:"visible"},{sExtends:"print",mColumns:"visible"}]},{sExtends:"text",sButtonText:"Reset",sButtonClass:"DTTT_button_reset",sButtonClassHover:"DTTT_button_reset_hover"},{sExtends:"text",sButtonText:"New Case",sButtonClass:"DTTT_button_new_case",sButtonClassHover:"DTTT_button_new_case_hover"}]},sAjaxSource:"lib/php/data/cases_load.php",bDeferRender:!0,fnInitComplete:function(){oTable.fnFilter("^$",oTable.fnGetColumnIndex("Date Close"),!0,!1),$(window).bind("resize",function(){oTable.fnDraw(!1),oTable.fnAdjustColumnSizing()}),$("div.dataTables_scrollHeadInner thead th.addSelects").each(function(){var e=oTable.fnGetColumnIndex($(this).attr("name"));this.innerHTML=fnCreateSelect(oTable.fnGetColumnData(e,!0,!1,!0))}),$("div.dataTables_filter").append('<select id="chooser"><option value="open" selected=selected>Open Cases Only</option><option value="closed">Closed Cases Only</option><option value="all">All Cases</option></select>  <a href="#" id="set_advanced">Advanced Search</a>'),$("div.ColVis button").removeClass().addClass("DTTT_button DTTT_button_collection ui-button ui-state-default"),$("#ToolTables_table_cases_6").click(function(){e()}),$("#table_cases").hasClass("can_add")?$("#ToolTables_table_cases_7").click(function(){$.post("lib/php/utilities/create_new_case.php",function(e){var t=$.parseJSON(e);if(t.error===!0)notify(t.message,!0);else{var a=t.newId;callCaseWindow(a,!0)}})}):$("#ToolTables_table_cases_7").remove(),$("#chooser").live("change",function(){switch($(this).val()){case"all":t="open and closed",oTable.fnFilter("",oTable.fnGetColumnIndex("Date Close"));break;case"open":t="open",oTable.fnFilter("^$",oTable.fnGetColumnIndex("Date Close"),!0,!1);break;case"closed":t="closed",oTable.fnFilter("^.+$",oTable.fnGetColumnIndex("Date Close"),!0,!1)}}),$("#set_advanced").live("click",function(e){e.preventDefault(),"none"!==$("tr.advanced, tr.advanced_2").css("display")?$("tr.advanced, tr.advanced_2").css({display:"none"}):($("th.ui-state-default").css({"border-bottom":"0px"}),$(".complex").children().css({display:"inline","margin-bottom":"0px"}),$("#open_range , #close_range").css({"margin-top":"18px"}),$("thead tr.advanced").toggle("slow"),$("#second_open_cell, #second_close_cell").css({visibility:"hidden"}),oTable.fnFilter("",oTable.fnGetColumnIndex("Date Close"),!0,!1),$("#chooser").val("all"),t="open and closed"),oTable.fnDraw()}),$("#addopenRow").click(function(e){e.preventDefault(),"visible"===$("#second_open_cell").css("visibility")?($(this).text("Add Condition"),$("#second_open_cell").css({visibility:"hidden"}),$("thead tr.advanced_2").hide("slow")):($(this).text("AND IS"),$("#second_open_cell").css({visibility:"visible"}),$("#date_open_2 , #date_close_2").css({width:"60%"}),$("thead tr.advanced_2").show("slow"))}),$("#addcloseRow").click(function(e){e.preventDefault(),"visible"===$("#second_close_cell").css("visibility")?($(this).text("Add Condition"),$("#second_close_cell").css({visibility:"hidden"}),$("thead tr.advanced_2").hide("slow")):($(this).text("AND IS"),$("#second_close_cell").css({visibility:"visible"}),$("#date_open_2 , #date_close_2").css({width:"60%"}),$("thead tr.advanced_2").show("slow"))}),$("thead input").live("keyup",function(){var e=$(this).attr("name"),t=oTable.fnGetColumnIndex(e);oTable.fnFilter(this.value,t)}),$("div.dataTables_scrollHeadInner tr.advanced th.addSelects select").live("change",function(){var e=$(this).parent(),t=oTable.fnGetColumnIndex(e.attr("name")),a=this.value,s="^"+a+"$";oTable.fnFilter(s,t,!0,!1,!1)}),$(function(){$("#date_open , #date_close, #date_open_2, #date_close_2").datepicker({changeMonth:!0,changeYear:!0,onSelect:function(){$(this).css({color:"black"}),oTable.fnDraw()}})}),$("#open_range, #open_range_2, #close_range, #close_range_2").live("change",function(){oTable.fnDraw()}),$("#table_cases tbody").click(function(e){var t=oTable.fnGetPosition(e.target.parentNode),a=oTable.fnGetData(t),s=a[0];callCaseWindow(s)}),$("#table_cases").addClass("print_content"),$("tr.advanced, tr.advanced_2").addClass("print_content_no"),$("#ToolTables_table_cases_5").live("click",function(){var e=$('<div class="dialog-casenote-delete" title="Print">Please use your browser\'s print function to print this table. Press escape when finished.</div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("destroy")}}});$(e).dialog("open")}),$("#processing").hide()},oLanguage:{sInfo:'Found <b>_TOTAL_</b> <span id="caseStatus"></span> cases',sInfoFiltered:"from a total of <b>_MAX_</b> cases",sEmptyTable:"No cases found.",sZeroRecords:"No cases found."},fnDrawCallback:function(){$("#caseStatus").text(t),$(".hasDatepicker").css({width:"60%"}),$(".complex").css({"min-width":"160px"})}}),router())}})}),$.fn.dataTableExt.afnFiltering.push(function(e,t){var a=document.getElementById("open_range").value,s=document.getElementById("open_range_2").value,i=document.getElementById("close_range").value,n=document.getElementById("close_range_2").value,o=document.getElementById("date_open").value,l=document.getElementById("date_open_2").value,c=document.getElementById("date_close").value,d=document.getElementById("date_close_2").value,r=t[6],_=t[7],p=o.substring(6,10)+o.substring(0,2)+o.substring(3,5),h=l.substring(6,10)+l.substring(0,2)+l.substring(3,5),u=c.substring(6,10)+c.substring(0,2)+c.substring(3,5),f=d.substring(6,10)+d.substring(0,2)+d.substring(3,5),v=r.substring(6,10)+r.substring(0,2)+r.substring(3,5),m=_.substring(6,10)+_.substring(0,2)+_.substring(3,5);if(""===p&&""===u)return!0;if(""!==p&&""===u&&""===h&&""===f){if("equals"===a&&v===p)return!0;if("less"===a&&p>v)return!0;if("greater"===a&&v>p)return!0}if(""===p&&""!==u&&""===h&&""===f){if("equals"===i&&m===u)return!0;if("less"===i&&u>m)return!0;if("greater"===i&&m>u)return!0}if(""!==p&&""!==u&&""===h&&""===f){if("equals"===a&&"equals"===i&&v===p&&m===u)return!0;if("greater"===a&&"less"===i&&v>p&&u>m)return!0;if("less"===a&&"greater"===i&&p>v&&m>u)return!0}if(""!==p&&""===u&&""!==h&&""===f){if("equals"===a&&"equals"===s&&v===p&&v===h)return!0;if("greater"===a&&"less"===s&&v>p&&h>v)return!0;if("less"===a&&"greater"===s&&p>v&&v>h)return!0}if(""===p&&""!==u&&""===h&&""!==f){if("equals"===i&&"equals"===n&&m===u&&m===f)return!0;if("greater"===i&&"less"===n&&m>u&&f>m)return!0;if("less"===i&&"greater"===n&&u>m&&m>f)return!0}if(""!==p&&""!==u&&""!==h&&""!==f){if("equals"===a&&"equals"===s&&"equals"===i&&"equals"===s&&v===p&&v===h&&m===u&&m===f)return!0;if("greater"===a&&"less"===s&&"greater"===i&&"less"===s&&v>p&&h>v&&m>u&&f>m)return!0}if(""!==p&&""!==u&&""!==h&&""===f){if("greater"===a&&"less"===s&&"equals"===i&&v>p&&h>v&&m===u)return!0;if("greater"===a&&"less"===s&&"greater"===i&&v>p&&h>v&&m>u)return!0;if("greater"===a&&"less"===s&&"less"===i&&v>p&&h>v&&u>m)return!0}if(""!==p&&""!==u&&""===h&&""!==f){if("greater"===i&&"less"===n&&"equals"===a&&m>u&&f>m&&v===p)return!0;if("greater"===i&&"less"===n&&"greater"===a&&m>u&&f>m&&v>p)return!0;if("greater"===i&&"less"===n&&"less"===a&&m>u&&f>m&&p>v)return!0}return!1});