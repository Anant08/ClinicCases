function addMoreMessages(s,e){var t,a=s[0].scrollTop,i=s[0].scrollHeight,o=100*(a/(i-s.height()));o>70&&(s.data("startVal")===void 0?(t=20,s.data("startVal",t)):(t=s.data("startVal")+parseInt(20),s.data("startVal",t)),"y"===s.data("searchOn")?$.post("lib/php/data/messages_load.php",{type:e,start:s.data("startVal"),s:s.data("searchTerm")},function(e){var t=$(e).find("div").length;return 0===t?!1:(s.append(e),layoutMessages(),s.highlight(s.data("searchTerm")),void 0)}):$.post("lib/php/data/messages_load.php",{type:e,start:s.data("startVal")},function(e){var t=$(e).find("div").length;return 0===t?!1:(s.append(e),layoutMessages(),void 0)}))}function checkOverflow(s){var e=s[0],t=e.style.overflow;t&&"visible"!==t||(e.style.overflow="hidden");var a=e.clientWidth<e.scrollWidth||e.clientHeight<e.scrollHeight;return e.style.overflow=t,a}function layoutMessages(){var s;$("p.tos").each(function(){$(this).next("p").hasClass("msg_to_more")||(s=checkOverflow($(this)),s===!0&&($(this).css({overflowY:"hidden"}),$(this).after('<p class="msg_to_more ex_tos"><a href="#">and others</a></p>')))}),$("p.ccs").each(function(){$(this).next("p").hasClass("msg_to_more")||(s=checkOverflow($(this)),s===!0&&($(this).css({overflowY:"hidden"}),$(this).after('<p class="msg_to_more"><a href="#">and others</a></p>')))}),$("div.msg").addClass("ui-corner-all"),$("div.msg_read").css({opacity:".5"})}$(document).ready(function(){var s=$("div#msg_panel");s.data("startVal"),$("#msg_nav").addClass("ui-toolbar ui-widget-header ui-corner-tl ui-corner-tr");var e=function(){$.post("lib/php/data/messages_load.php",{type:"inbox",start:"0"},function(e){s.html(e),$("div.msg").addClass("ui-corner-all"),s.data("startVal",0),layoutMessages()})};e();var t=setInterval(e(),9e4);$("div.msg_bar").live("click",function(){var a=$(this).parent();if($(this).parent().hasClass("msg_closed")){a.removeClass("msg_closed").addClass("msg_opened"),a.find("p.tos, p.ccs, p.subj").css({color:"black"}),a.css({opacity:"1"});var i=a.attr("data-id");a.data("verticalPos",$("div#msg_panel")[0].scrollTop),clearTimeout(t),$(this).next("div").find("div.msg_replies").load("lib/php/data/messages_load.php",{type:"replies",thread_id:i},function(){var e=$(this).closest("div.msg")[0].scrollHeight;a.animate({height:e}),"y"===s.data("searchOn")&&s.highlight(s.data("searchTerm"))}),$.post("lib/php/data/messages_process.php",{action:"mark_read",id:i},function(){msgCheck()})}else a.removeClass("msg_opened").addClass("msg_closed"),a.find("div.msg_reply_text").hide().find("textarea").val(""),a.find("div.msg_forward").hide(),a.css({opacity:".5"}),a.animate({height:"90"}),t=setInterval(e(),9e4)}),$("button#msg_archive_all_button").button({icons:{primary:"fff-icon-email-go"},text:!0}).click(function(){var s=$('<div title="Send All to Archive?">Send all messages in inbox to archive?</div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/messages_process.php",{action:"archive_all"},function(s){var t=$.parseJSON(s);t.error===!0?notify(t.message,!0):(notify(t.message),e(),msgCheck())}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(s).dialog("open")}),$("button#new_msg_button").button({icons:{primary:"fff-icon-email-add"},text:!0}).click(function(){$("div#msg_panel").load("lib/php/data/messages_load.php #msg_new",{new_message:"y"},function(){clearTimeout(t);var s=$("div#msg_new");s.show().addClass("msg_opened"),s.find('select[name = "new_tos[]"], select[name = "new_ccs[]"], select[name = "new_file_msg"]').chosen(),$("#msg_new_button_cancel").click(function(a){a.preventDefault(),$("#new_msg_form")[0].reset(),s.removeClass("msg_opened"),e(),t=setInterval(e(),9e4),notify("New message cancelled")}),$("#msg_new_button_submit").click(function(s){s.preventDefault();var a=$("#new_msg_form").serializeArray();return null===$('select[name="new_tos"]').val()?(notify("<p>You must select at least one recipient</p>"),!1):($.post("lib/php/data/messages_process.php",a,function(s){var a=$.parseJSON(s);a.error===!0?notify(a.message,!0):($("#new_msg_form")[0].reset(),e(),t=setInterval(e(),9e4),notify("Message sent"))}),void 0)})})}),$("select#msg_view_chooser").change(function(){var a=$(this).val();"inbox"!==a?clearTimeout(t):t=setInterval(e(),9e4),s.html("<p>Loading...</p>"),$.post("lib/php/data/messages_load.php",{type:a,start:"0"},function(e){s.html(e),s.data("startVal",0),layoutMessages(),$("div#msg_panel")[0].scrollTop=0})}),s.bind("scroll",function(){var e=null;e="y"===s.data("searchOn")?"search":$("select#msg_view_chooser").val(),addMoreMessages(s,e)}),$("span.star_msg").live("click",function(s){s.stopPropagation();var e=$(this).closest("div.msg").attr("data-id");$(this).hasClass("star_off")?($(this).removeClass("star_off").addClass("star_on"),$(this).html('<img src = "html/ico/starred.png">'),$.post("lib/php/data/messages_process.php",{action:"star_on",id:e},function(s){var e=$.parseJSON(s);e.error===!0&&notify(e.message,!0)})):($(this).removeClass("star_on").addClass("star_off"),$(this).html('<img src = "html/ico/not_starred.png">'),$.post("lib/php/data/messages_process.php",{action:"star_off",id:e},function(s){var e=$.parseJSON(s);e.error===!0&&notify(e.message,!0)}))}),$("div.msg_actions a").live("click",function(s){s.preventDefault();var e,t=$(this).attr("class");"forward"===t&&(e=$(this).closest("div.msg").height()+300,$(this).parent().siblings("div.msg_forward").show().find("select").chosen(),$(this).closest("div.msg").height(e),$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(t)),"reply"===t&&(e=$(this).closest("div.msg").height()+250,$(this).closest("div.msg").height(e),$(this).parent().siblings("div.msg_reply_text").show().find("textarea").addClass(t))}),$("button.msg_send").live("click",function(){var s=$(this).prev().val(),e=$(this).closest("div.msg").attr("data-id"),t=$(this).prev().attr("class"),a=$(this).parent().siblings("div.msg_replies"),i=$(this).closest("div.msg"),o=$(this).parent().siblings("div.msg_forward").find("select").val();$.post("lib/php/data/messages_process.php",{action:t,thread_id:e,reply_text:s,forward_tos:o},function(s){var t=$.parseJSON(s);t.error===!0?notify(t.message,!0):(notify(t.message),a.load("lib/php/data/messages_load.php",{type:"replies",thread_id:e},function(){i.animate({height:"90"}),i.removeClass("msg_opened").addClass("msg_closed").css({opacity:".5"}),i.find("div.msg_reply_text").hide().find("textarea").val(""),i.find("div.msg_forward").hide(),i.find("div.msg_forward select").val(""),$("div#msg_panel").scrollTop(i.data("verticalPos"))}))})}),$("a.archive, a.unarchive").live("click",function(){var s=$(this).closest("div.msg"),e=s.attr("data-id"),t=$(this).attr("class");$.post("lib/php/data/messages_process.php",{action:t,id:e},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),s.remove())})}),$("a.print").live("click",function(){elPrint($(this).closest(".msg"),"Message")}),$("p.msg_to_more").live("click",function(s){s.preventDefault();var e,t;if($(this).hasClass("ex_tos")){var a=$(this).siblings("p.tos");e=a[0].scrollHeight,$(this).hasClass("expanded")?($(this).removeClass("expanded"),a.css({height:"20"}),$(this).html('<a href="#">and others</a>'),t=$(this).closest("div.msg").height()-e,$(this).closest("div.msg").height(t)):(a.css({height:e}),$(this).addClass("expanded"),$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>'),t=$(this).closest("div.msg").height()+e,$(this).closest("div.msg").height(t))}else{var i=$(this).siblings("p.ccs");e=i[0].scrollHeight,$(this).hasClass("expanded")?($(this).removeClass("expanded"),i.css({height:"20"}),$(this).html('<a href="#">and others</a>'),t=$(this).closest("div.msg").height()-e,$(this).closest("div.msg").height(t)):(i.css({height:e}),$(this).addClass("expanded"),$(this).html('<a href="#" class="msg_to_more_hide">Hide</a>'),t=$(this).closest("div.msg").height()+e,$(this).closest("div.msg").height(t))}}),$("input.messages_search").live("focusin",function(){$(this).val(""),$(this).css({color:"black"}),$(this).next(".msg_search_clear").show()}),$("input.messages_search").live("keyup",function(e){if(13===e.which){clearTimeout(t),s.data("startVal",0),s.data("searchOn","y"),s.data("searchTerm",$(this).val()),s.html("<p>Searching...</p>");var a=$(this).val();s.load("lib/php/data/messages_load.php",{type:"search",start:"0",s:a},function(){s.scrollTop(0),layoutMessages(),$("div.msg_bar_left").css({width:"470px"}),$("div.msg_bar_right").css({width:"310px"}),s.highlight(a)})}}),$(".msg_search_clear").live("click",function(){s.html("<p>Loading...</p>"),s.data("searchOn","n"),s.data("searchTerm",""),s.data("startVal",0),$(this).prev().val("Search Messages"),$(this).prev().css({color:"#AAA"}),e(),t=setInterval(e(),9e4),$("div#msg_panel")[0].scrollTop=0,$(this).hide()})});