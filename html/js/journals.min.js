function callJournal(e,t,o){var a=[];if(a.push(e),1>$("div#journal_detail_window").length){var n='<div id="journal_detail_window"></div>';$("#content").append(n)}t===!0?$("#journal_detail_window").load("lib/php/data/journals_detail_load.php",{id:a,view:"edit"},function(){if($(this).show("fold",1e3,function(){function e(t,o){var l=o[0].get_content(),i=$('select[name="reader_select[]"]').val(),s="Saving...";l!==t&&(n.find("span.save_status").html(s),$.post("lib/php/data/journals_process.php",{type:"edit",id:a,text:l,readers:i},function(e){var t=$.parseJSON(e);t.error?n.find("span.save_status").html(t.message):n.find("span.save_status").html(t.message)}),t=l),setTimeout(function(){e(t,o)},3e3)}var t=$(this).find(".journal_edit").rte({css:["lib/javascripts/lwrte/default2.css"],width:900,height:500,controls_rte:rte_toolbar}),o="",n=$("#journal_detail_window");e(o,t)}),$(window).bind("beforeunload",function(){var e=$('select[name="reader_select[]"]');return e.length>0&&null===e.val()?(e.parent().find("label").first().addClass("ui-state-error"),"You haven't specified who is supposed to read this journal.Please select a reader in the box below."):void 0}),$("button.journal_close").button({icons:{primary:"fff-icon-cancel"},label:"Close"}).click(function(){var e=$('select[name="reader_select[]"]');return e.length>0&&null===e.val()?(notify("<p>Please select the users to whom this journal is to be sent.</p>",!0),e.parent().find("label").first().addClass("ui-state-error"),!1):(oTable.fnReloadAjax(),$("#journal_detail_window").hide("fold",1e3),void 0)}),$('select[name="reader_select[]"]').chosen().change(function(){if($('input[name="remember_choice"]').is(":checked")){var e=$('select[name="reader_select[]"]').val();$.cookie("ClinicCases_journal",e,{expires:365})}var t=$('select[name="reader_select[]"]').val();$.post("lib/php/data/journals_process.php",{type:"update_readers",id:a,readers:t})}),o===!0){if(null!==$.cookie("ClinicCases_journal")){var e=$.cookie("ClinicCases_journal").split(",");$('select[name="reader_select[]"]').val(e),$('select[name="reader_select[]"]').trigger("liszt:updated"),$('input[name = "remember_choice"]').attr("checked","checked")}}else o===!1&&t===!0&&null!==$.cookie("ClinicCases_journal")&&$('input[name = "remember_choice"]').attr("checked","checked");$('input[name = "remember_choice"]').change(function(){var e=$('select[name="reader_select[]"]').val();$(this).is(":checked")?$.cookie("ClinicCases_journal",e,{expires:365}):null!==$.cookie("ClinicCases_journal")&&$.cookie("ClinicCases_journal",null)})}):$("#journal_detail_window").load("lib/php/data/journals_detail_load.php",{id:a},function(){$(this).show("fold",1e3),$.post("lib/php/data/journals_process.php",{id:a,type:"mark_read"},function(e){var t=$.parseJSON(e);t.error===!0&&notify(t.message)}),$("button.journal_delete").length&&$("button.journal_delete").button({icons:{primary:"fff-icon-page-delete"}}).click(function(){var e=$('<div title="Are you sure?"><p>Permanently delete this journal?</p></div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/journals_process.php",{id:a,type:"delete"},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),oTable.fnReloadAjax(),$("#journal_detail_window").hide("fold",1e3))}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(e).dialog("open")}),$("button.journal_edit").length&&$("button.journal_edit").button({icons:{primary:"fff-icon-page-edit"}}).click(function(){callJournal(a[0],!0,!1)}),$("button.journal_print").length&&$("button.journal_print").button({icons:{primary:"fff-icon-printer"}}).click(function(){elPrint($("div.journal_detail"),"Journal")}),$("button.journal_close").button({icons:{primary:"fff-icon-cancel"},label:"Close"}).click(function(){oTable.fnReloadAjax(),$("#journal_detail_window").hide("fold",1e3)}),$("textarea.expand").livequery(function(){$(this).TextAreaExpander(40,300).css({color:"#AAA"}).bind("focus",function(){$(this).val("").css({color:"black"}).unbind("focus")})})})}function fnResetAllFilters(){oTable.fnSettings(),oTable.fnFilter(""),ColReorder.fnReset(oTable),$("input").each(function(){this.value=""}),$("select").each(function(){this.selectedIndex="0"}),oTable.fnFilter("^$",oTable.fnGetColumnIndex("Read"),!0,!1),oTable.fnSort([[oTable.fnGetColumnIndex("Date Submitted"),"desc"]]),oTable.fnDraw()}var oTable;$(document).ready(function(){var e=$("#content").height()-100,t="unread";oTable=$("#table_journals").dataTable({sAjaxSource:"lib/php/data/journals_load.php",aoColumns:[{sTitle:"",bSortable:!1,sWidth:"40px"},{sTitle:"Id",bSearchable:!1,bVisible:!1},{sTitle:"Name"},{sTitle:"Submitted To",bSearchable:!0,bVisible:!1},{sTitle:"Text",bVisible:!1},{sTitle:"Date Submitted",sType:"date"},{sTitle:"Archived",bVisible:!1},{sTitle:"Read",bVisible:!1},{sTitle:"Commented",bVisible:!1},{sTitle:"Comments",bSearchable:!1,bVisible:!1}],oColVis:{aiExclude:[0,1],bRestore:!0,buttonText:"Columns"},oTableTools:{aButtons:[{sExtends:"text",sButtonText:"Reset",sButtonClass:"DTTT_button_reset",sButtonClassHover:"DTTT_button_reset_hover"},{sExtends:"text",sButtonText:"New Journal",sButtonClass:"DTTT_button_new_case",sButtonClassHover:"DTTT_button_new_case_hover"}]},aaSorting:[[5,"desc"]],bDeferRender:!0,bAutoWidth:!1,bProcessing:!0,bJQueryUI:!0,bScrollInfinite:!0,sScrollY:e,iDisplayLength:30,iScrollLoadGap:200,bSortCellsTop:!0,sDom:'R<"H"fTCi>rt<"F"<"journal_action">>',oLanguage:{sInfo:'Showing <b>_TOTAL_</b> <span id="journalStatus"></span> journals',sZeroRecords:'No <span id="journalStatus"></span> journals found.',sInfoEmpty:"Showing 0 journals",sInfoFiltered:"from a total of <b>_MAX_</b>",sEmptyTable:"No journals found."},fnInitComplete:function(){$("#processing").hide(),$("div.ColVis button").removeClass().addClass("DTTT_button DTTT_button_collection ui-button ui-state-default"),$("div.journal_action").html('<label>With displayed journals:</label><select id="journal_action_chooser"><option value="" selected=selected disabled>Choose Action</option><option value="archive">Archive</option><option value="mark_read">Mark Read</option><option value="mark_unread">Mark Unread</option></select>'),$("#journal_action_chooser").change(function(){var e=oTable.fnGetFilteredData(),o=[],a=$(this).val(),n=a.replace("_"," as ");$.each(e,function(){o.push($(this)[1])});var l=$('<div title="Are you sure?">This will '+n+" "+e.length+" journals.  Are you sure you want to do that?</div>").dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/journals_process.php",{type:a,id:o},function(e){var o=$.parseJSON(e);o.error===!0?notify(o.message,!0):(notify(o.message),oTable.fnReloadAjax(),fnResetAllFilters(),t="unread")}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(l).dialog("open")}),$("div.dataTables_filter").append('<select id="chooser"><option value="unread" selected=selected>Unread</option><option value="read">Read</option><option value="archived">Archived</option><option value="all">All</option></select>'),$("#chooser").live("change",function(){switch($(this).val()){case"unread":t="unread",oTable.fnFilter("^$",oTable.fnGetColumnIndex("Read"),!0,!1),oTable.fnFilter("",oTable.fnGetColumnIndex("Archived"));break;case"read":t="read",oTable.fnFilter("yes",oTable.fnGetColumnIndex("Read"),!0,!1),oTable.fnFilter("",oTable.fnGetColumnIndex("Archived"));break;case"archived":t="archived",oTable.fnFilter("yes",oTable.fnGetColumnIndex("Archived")),oTable.fnFilter("",oTable.fnGetColumnIndex("Read"));break;case"all":t="all",oTable.fnFilter("",oTable.fnGetColumnIndex("Archived"),!0,!1),oTable.fnFilter("",oTable.fnGetColumnIndex("Read"),!0,!1)}}),oTable.fnFilter("^$",oTable.fnGetColumnIndex("Read"),!0,!1),oTable.fnFilter("^$",oTable.fnGetColumnIndex("Archived"),!0,!1),$("div.ColVis button").removeClass().addClass("DTTT_button DTTT_button_collection ui-button ui-state-default"),$("#ToolTables_table_journals_0").click(function(){fnResetAllFilters()}),$("#table_journals").hasClass("can_add")?$("#ToolTables_table_journals_1").click(function(){$.post("lib/php/data/journals_process.php",{type:"new"},function(e){var t=$.parseJSON(e);if(t.error===!0)notify(t.message,!0);else{var o=t.newId;callJournal(o,!0,!0)}})}):$("#ToolTables_table_journals_1").remove(),$("#table_journals tbody").click(function(e){var t=oTable.fnGetPosition(e.target.parentNode),o=oTable.fnGetData(t),a=o[1];callJournal(a,!1,!1)}),$(window).bind("resize",function(){oTable.fnDraw(!1),oTable.fnAdjustColumnSizing()}),router()},fnDrawCallback:function(){$("#journalStatus").text(t)}})}),$("a.comment_save").live("click",function(e){e.preventDefault();var t=[];t.push($(this).closest("div.journal_body").attr("data-id"));var o=$(this).siblings("textarea").val();$.post("lib/php/data/journals_process.php",{type:"add_comment",id:t,comment_text:o},function(e){var o=$.parseJSON(e);o.error===!0?notify(o.message):($("div.journal_comments").load("lib/php/data/journals_detail_load.php div.journal_comments",{id:t}),notify(o.message))})}),$("a.comment_delete").live("click",function(e){e.preventDefault();var t=$(this).parent().attr("data-id"),o=[];o.push($(this).closest("div.journal_body").attr("data-id"));var a=$('<div title="Are you sure?"><p>Delete this comment?</p></div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/data/journals_process.php",{type:"delete_comment",id:o,comment_id:t},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message):($("div.journal_comments").load("lib/php/data/journals_detail_load.php div.journal_comments",{id:o}),notify(t.message))}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(a).dialog("open")}),$(function(){$("div.comment").livequery(function(){$(this).hasClass("can_delete")&&$(this).mouseover(function(){$(this).find("a.comment_delete").show()}).mouseout(function(){$(this).find("a.comment_delete").hide()})})});