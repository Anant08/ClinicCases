//Scripts for users page
//set the intial value for the userStatus span on load
//Reset displayed data
//Create user detail window
//
//Listen for user data editing buttons
//
//Listen for the edit button
//Listen for the delete button
//
//Listen for image editing buttons
//
function fnResetAllFilters(){for(var e=oTable.fnSettings(),t=0;e.aoPreSearchCols.length>t;t++)e.aoPreSearchCols[t].sSearch="";oTable.fnFilter(""),ColReorder.fnReset(oTable),$("input").each(function(){this.value=""}),$("select").each(function(){this.selectedIndex="0"}),$("#addDateRow").text("Add Condition"),$("tr.advanced, tr.advanced_2").hide("fast"),oTable.fnFilter("^active",oTable.fnGetColumnIndex("Status"),!0,!1),chooserVal="active",oTable.fnSort([[oTable.fnGetColumnIndex("Last Name"),"asc"]]);var a=Math.round(.85*$("#content").height());$(".dataTables_scrollBody").height(a),oTable.fnDraw()}function showUserDetail(e){if(1>$("div#user_detail_window").length){var t='<div id="user_detail_window"></div>';$("#content").append(t)}$("#user_detail_window").load("lib/php/users/user_detail_load.php",{id:e,view:"display"},function(){$(this).show("fold",1e3),$("div.user_detail_control button").button({icons:{primary:"fff-icon-cancel"},label:"Close"}).click(function(){$("#user_detail_window").hide("fold",1e3)})})}function userEdit(e,t){var a;if(a=t===void 0?"update":"create",1>$("div#user_detail_window").length){var i='<div id="user_detail_window"></div>';$("#content").append(i)}$("#user_detail_window").load("lib/php/users/user_detail_load.php",{id:e,view:a},function(){"none"===$(this).css("display")&&$(this).show("fold",1e3),$(this).find("input,select").change(function(){$("#user_detail_window").data("dirty","true"),$(window).bind("beforeunload",function(){return"You have unsaved changes to this user. If you proceed, they will be lost."})}),$("div.user_detail_control button").button({icons:{primary:"fff-icon-cancel"},label:"Close"}).click(function(){return"true"===$("#user_detail_window").data("dirty")?(notify("<p>You have unsaved changes to this user.  Please either submit the changes or cancel.</p>",!0),!1):($("#user_detail_window").hide("fold",1e3),void 0)}),$("div.user_detail_edit_actions button:eq(0)").click(function(t){t.preventDefault(),"create"===a&&$.post("lib/php/users/users_process.php",{action:"delete",users:e},function(e){var t=$.parseJSON(e);t.error===!0?notify("There was an error cancelling this user.",!0):notify("New user deleted")}),$("#user_detail_window").data("dirty","false"),$(window).unbind("beforeunload"),$("#user_detail_window").hide("fold",1e3)}),$("div.user_detail_edit_actions button:eq(1)").click(function(t){t.preventDefault();var a=$('form[name="user_edit_form"]'),i=validUser(a);if(i.length)return notify(i,!0),a.find(".ui-state-error").click(function(){$(this).removeClass("ui-state-error")}),!1;var s=a.serializeArray(),n="";$.each(s,function(e,t){"supervisors"===t.name&&(n+=t.value+",")});var o=$('form[name="user_edit_form"] :not(select[name="supervisors"])').serializeArray();o.push({name:"supervisors",value:n}),$.post("lib/php/users/users_process.php",o,function(t){var a=$.parseJSON(t);a.error===!0?notify(a.message,!0):(notify(a.message),$("span.user_data_display_area").load("lib/php/users/user_detail_load.php span.user_data_display_area",{id:e,view:"display"}),oTable.fnReloadAjax(),$("#user_detail_window").data("dirty","false"),$(window).unbind("beforeunload"))})}),$("select.supervisor_chooser,select.status_chooser,select.group_chooser").chosen(),$("select.supervisor_chooser").next().css({"margin-top":"10px"}),$("select.supervisor_chooser").prev().css({"vertical-align":"top"}),$('.user_detail_left input[name="first_name"],.user_detail_left input[name="last_name"]').keyup(function(){var e=$('.user_detail_left input[name="first_name"]').val(),t=$('.user_detail_left input[name="last_name"]').val();$("span.name_display").html(e+" "+t)}),new qq.FileUploader({element:$("div.user_change_picture")[0],action:"lib/php/utilities/file_upload_user_image.php",allowedExtensions:["jpg","jpeg","png","gif","bmp"],params:{preview:"yes"},template:'<div class="qq-uploader"><div class="qq-upload-drop-area"><span>Drop files here to upload</span></div><div class="qq-upload-button">Change Picture</div><ul class="qq-upload-list"></ul></div>',onComplete:function(e,t,a){function i(e){if(parseInt(e.w)>0){var t=100/e.w,a=100/e.h,i=$("div.user_picture img").width(),s=$("div.user_picture img").height();n.css({width:Math.round(t*i)+"px",height:Math.round(a*s)+"px",marginLeft:"-"+Math.round(t*e.x)+"px",marginTop:"-"+Math.round(a*e.y)+"px",visibility:"visible"}).show()}}function s(e){$("div.user_picture img").data("cd",{x:e.x,y:e.y,w:e.w,h:e.h})}a.error||$("div.user_picture").html('<img src="'+a.img+'">').append('<div class = "user_picture_preview"><img id = "preview" src="'+a.img+'"></div>'),$("ul.qq-upload-list").length>0&&$("ul.qq-upload-list li:not(:last)").hide(),$("div.user_picture img").Jcrop({aspectRatio:1,onChange:i,onSelect:s});var n=$("#preview");$("ul.qq-upload-list, div.crop_msg").css({display:"none"})&&$("ul.qq-upload-list, div.crop_msg").show(),1>$("div.crop_msg").length&&$("div.qq-uploader").append('<div class="crop_msg">Select the part of the image to be usedand then <button class="image_save">Save</button> or <button class="image_cancel">Discard</button></div>'),$("div.user_detail_edit_actions").find("button").attr("disabled","disabled")}})})}var oTable,aoColumns,chooserVal="active";$(document).ready(function(){oTable=$("#table_users").dataTable({bJQueryUI:!0,sAjaxSource:"lib/php/users/group_load.php",bScrollInfinite:!0,bDeferRender:!0,bScrollCollapse:!1,iDisplayLength:20,bSortCellsTop:!0,aaSorting:[[3,"asc"]],sScrollY:Math.round(.85*$("#content").height()),aoColumns:[{bSearchable:!1,bVisible:!1},{bSortable:!1,sWidth:"40px"},null,null,null,null,{bVisible:!1},{bVisible:!1},null,{bVisible:!1},null,{bVisible:!1},{sType:"date"}],sDom:'<"H"lfTrCi>t',oColVis:{aiExclude:[0],bRestore:!0,buttonText:"Columns",fnStateChange:function(e){$("div.dataTables_scrollHeadInner thead th.addSelects:empty").each(function(){this.innerHTML=fnCreateSelect(oTable.fnGetColumnData(e,!0,!1,!0))})}},oTableTools:{sSwfPath:"lib/DataTables-1.8.2/extras/TableTools/media/swf/copy_cvs_xls_pdf.swf",aButtons:[{sExtends:"collection",sButtonText:"Print/Export",aButtons:[{sExtends:"copy",mColumns:"visible"},{sExtends:"csv",mColumns:"visible"},{sExtends:"xls",mColumns:"visible"},{sExtends:"pdf",mColumns:"visible"},{sExtends:"print",mColumns:"visible"}]},{sExtends:"text",sButtonText:"Reset",sButtonClass:"DTTT_button_reset",sButtonClassHover:"DTTT_button_reset_hover"}]},oLanguage:{sInfo:'There are <b>_TOTAL_</b> <span id="userStatus"></span> users in your group',sInfoFiltered:"from a total of <b>_MAX_</b> users",sEmptyTable:"Nobody is in your group."},fnInitComplete:function(){oTable.fnFilter("^active",oTable.fnGetColumnIndex("Status"),!0,!1),$(window).bind("resize",function(){oTable.fnDraw(!1),oTable.fnAdjustColumnSizing()}),$("div.ColVis button").removeClass().addClass("DTTT_button DTTT_button_collection ui-button ui-state-default"),$("#ToolTables_table_users_6").click(function(){fnResetAllFilters()}),$("div.dataTables_filter").append('<select id="chooser"><option value="active" selected=selected>Active Users</option><option value="inactive">Inactive Users</option><option value="all">All Users</option></select>  <a href="#" id="set_advanced">Advanced Search</a>'),$("#chooser").live("change",function(){switch($(this).val()){case"all":chooserVal="active and inactive",oTable.fnFilter("",oTable.fnGetColumnIndex("Status"));break;case"active":chooserVal="active",oTable.fnFilter("^active",oTable.fnGetColumnIndex("Status"),!0,!1);break;case"inactive":chooserVal="inactive",oTable.fnFilter("^inactive",oTable.fnGetColumnIndex("Status"),!0,!1)}}),$("div.dataTables_scrollHeadInner thead th.addSelects").each(function(){var e=oTable.fnGetColumnIndex($(this).attr("name"));this.innerHTML=fnCreateSelect(oTable.fnGetColumnData(e,!0,!1,!0))}),$("thead .DataTables_sort_wrapper").first().css({color:"white"}),$("th").first().css({"border-left":"1px solid white","border-bottom":"1px solid white"}),$("#set_advanced").live("click",function(e){if(e.preventDefault(),"none"!==$("tr.advanced, tr.advanced_2").css("display")){$("tr.advanced, tr.advanced_2").css({display:"none"});var t=Math.round(.85*$("#content").height());$(".dataTables_scrollBody").height(t),oTable.fnFilter("^active",oTable.fnGetColumnIndex("Status"),!0,!1),$("#chooser").val("active"),chooserVal="active"}else{$("th.ui-state-default").css({"border-bottom":"0px"}),$(".complex").children().css({display:"inline","margin-bottom":"0px"}),$("#date_created_range").css({"margin-top":"18px"}),$("thead tr.advanced").toggle("fast");var a=$(".dataTables_scrollBody").height(),i=$("tr.advanced").height();$(".dataTables_scrollBody").height(a-i),oTable.fnFilter("",oTable.fnGetColumnIndex("Status"),!0,!1),$("#chooser").val("all"),chooserVal="active and inactive"}oTable.fnDraw()}),$("#addDateRow").click(function(e){if(e.preventDefault(),"visible"===$("#second_open_cell").css("visibility"))$(this).text("Add Condition"),$("#second_open_cell").css({visibility:"hidden"}),$("thead tr.advanced_2").hide("fast");else{$(this).text("AND IS"),$("#second_open_cell").css({visibility:"visible"}),$("thead tr.advanced_2").show("fast");var t=$(".dataTables_scrollBody").height(),a=$("tr.advanced_2").height();$(".dataTables_scrollBody").height(t-a)}}),$("thead input").live("keyup",function(){var e=$(this).attr("name"),t=oTable.fnGetColumnIndex(e);oTable.fnFilter(this.value,t)}),$(function(){$('input[name="date_created"], input[name="date_created_2"]').datepicker({changeMonth:!0,changeYear:!0,onSelect:function(){$(this).css({color:"black"}),oTable.fnDraw()}})}),$("div.dataTables_scrollHeadInner tr.advanced th.addSelects select").live("change",function(){var e=$(this).parent(),t=oTable.fnGetColumnIndex(e.attr("name")),a=this.value,i="^"+a+"$";oTable.fnFilter(i,t,!0,!1,!1)}),$.fn.dataTableExt.afnFiltering.push(function(e,t){var a=document.getElementById("date_created_range").value,i=document.getElementById("date_created_range_2").value,s=document.getElementById("date_created").value,n=document.getElementById("date_created_2").value,o=t[12],l=s.substring(6,10)+s.substring(0,2)+s.substring(3,5),r=n.substring(6,10)+n.substring(0,2)+n.substring(3,5),d=o.substring(6,10)+o.substring(0,2)+o.substring(3,5);if(""===l)return!0;if(""!==l&&""===r){if("equals"===a&&d===l)return!0;if("less"===a&&l>d)return!0;if("greater"===a&&d>l)return!0}if(""!==l&&""!==r){if("equals"===a&&"equals"===i&&d===l&&d===r)return!0;if("greater"===a&&"less"===i&&d>l&&r>d)return!0;if("less"===a&&"greater"===i&&l>d&&d>r)return!0}return!1}),$("#date_created_range, #date_created_range_2").live("change",function(){oTable.fnDraw()}),$("#table_users tbody").click(function(e){var t=oTable.fnGetPosition(e.target.parentNode),a=oTable.fnGetData(t),i=a[0];showUserDetail(i)}),$("#processing").hide(),$.post("lib/php/users/check_for_new_users.php",function(e){var t=$.parseJSON(e);if(t.new_user===!0){var a,i;1===t.number?(a="is one new user",i="application"):(a="are "+t.number+" new users",i="applications");var s=$('<div title="New Users"><p>There '+a+"awaiting approval from you.</p> <br /><p>Would you like to review the "+i+" now?</p></div>").dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){chooserVal="new",$("#chooser").val("inactive"),oTable.fnFilter("^inactive",oTable.fnGetColumnIndex("Status"),!0,!1),oTable.fnFilter("yes",oTable.fnGetColumnIndex("New"),!0,!1),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(s).dialog("open")}}),$("button#ToolTables_table_users_7").click(function(){$.post("lib/php/users/new_user.php",function(e){var t=$.parseJSON(e);if(t.error===!0)notify(t.message,!0);else{var a=t.id;userEdit(a,!0)}})})},fnDrawCallback:function(){$("#userStatus").text(chooserVal),$(".complex").css({"min-width":"160px"})}})}),$("div.user_detail_actions button.user_edit").live("click",function(){var e=$(".user_data_display_area").attr("data-id");userEdit(e)}),$("div.user_detail_actions button.user_delete").live("click",function(){var e=$(".user_data_display_area").attr("data-id"),t=$('<div title="Are you sure?"><p>It is usually best to deactivate, rather than delete,a user account.</p><br /><p>To deactivate, click the edit button below and then change the user status.</p><br /> <p>You should only delete if this user account was created by error or as a result of spam. Are you sure you want to delete?</p></div>').dialog({autoOpen:!1,resizable:!1,modal:!0,buttons:{Yes:function(){$.post("lib/php/users/users_process.php",{action:"delete",users:e},function(e){var t=$.parseJSON(e);t.error===!0?notify(t.message,!0):(notify(t.message),oTable.fnReloadAjax(),$.post("lib/php/users/check_for_new_users.php",function(e){var t=$.parseJSON(e);1>parseInt(t.number)&&fnResetAllFilters()}),$("#user_detail_window").hide("fold",1e3))}),$(this).dialog("destroy")},No:function(){$(this).dialog("destroy")}}});$(t).dialog("open")}),$("button.image_cancel").live("click",function(e){e.preventDefault();var t=$(".user_data_display_area").attr("data-id"),a=[];$("span.qq-upload-file").each(function(){a.push($(this).text().toLowerCase())}),$.post("lib/php/utilities/file_upload_user_image.php",{cancel:"yes",del:a}),$("div.user_picture").load("lib/php/users/user_detail_load.php div.user_picture",{id:t,view:"edit"}),$("div.crop_msg").remove(),$("ul.qq-upload-list").hide(),$("div.user_detail_edit_actions").find("button").removeAttr("disabled")}),$("button.image_save").live("click",function(e){e.preventDefault();var t=$(".user_data_display_area").attr("data-id"),a=[];$("span.qq-upload-file").each(function(){a.push($(this).text().toLowerCase())});var i=$("div.user_picture img").data(),s=$("span.qq-upload-file:last").text().toLowerCase();return i.cd===void 0?(notify("<p>Please use your mouse to select the part of the image which will be used.</p>",!0),!1):($.post("lib/php/utilities/file_upload_user_image.php",{id:t,img:s,del:a,x:i.cd.x,y:i.cd.y,h:i.cd.h,w:i.cd.w},function(){$("p.top_row").load("lib/php/users/user_detail_load.php p.top_row",{id:t,view:"edit"}),$("div.user_picture").load("lib/php/users/user_detail_load.php div.user_picture",{id:t,view:"edit"}),$("ul.qq-upload-list, div.crop_msg").hide(),$("div.user_detail_edit_actions").find("button").removeAttr("disabled"),oTable.fnReloadAjax()}),void 0)});